<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>Testing</title>

    <!--
        Licensed to the Apache Software Foundation (ASF) under one
        or more contributor license agreements.  See the NOTICE file
        distributed with this work for additional information
        regarding copyright ownership.  The ASF licenses this file
        to you under the Apache License, Version 2.0 (the
        "License"); you may not use this file except in compliance
        with the License.  You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

        Unless required by applicable law or agreed to in writing,
        software distributed under the License is distributed on an
        "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        KIND, either express or implied.  See the License for the
        specific language governing permissions and limitations
        under the License.
    -->

    <!-- No caching headers -->
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="-1" />


    <!-- TODO: need to (re)instate CDN in the future (not using for now just so can develop off-line -->
    <link href="../css/foundation/5.5.1/foundation.css" rel="stylesheet" />
    <script src="../js/foundation/5.5.1/vendor/modernizr.js"></script>
    <link href="../css/asciidoctor/colony.css" rel="stylesheet">
    <link href="../css/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">




    <link href="../css/github-fork-ribbon-css/0.1.1/gh-fork-ribbon.css" rel="stylesheet" />
    <!--[if lt IE 9]>
      <link href="../css/github-fork-ribbon-css/0.1.1/gh-fork-ribbon.ie.css" rel="stylesheet" />
    <![endif]-->



    <style type="text/css">
        pre code {
            background-color: inherit;
            border-style: none;
        }

        pre code > span:first-child {
            margin-left: -5px;
        }

    <style>

    <!--
    <style type="text/css">
        /* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}

        pre.CodeRay code {
            background-color: inherit;
            border-style: none;
        }

        pre.CodeRay code > span:first-child {
            margin-left: -5px;
        }

        .literalblock pre,
        .listingblock pre:not(.highlight),
        .listingblock pre[class="highlight"],
        .listingblock pre[class^="highlight "],
        .listingblock pre.CodeRay,
        .listingblock pre.prettyprint {
            background: rgb(253, 250, 246);
         }
        .sidebarblock .literalblock pre,
        .sidebarblock .listingblock pre:not(.highlight),
        .sidebarblock .listingblock pre[class="highlight"],
        .sidebarblock .listingblock pre[class^="highlight "],
        .sidebarblock .listingblock pre.CodeRay,
        .sidebarblock .listingblock pre.prettyprint {
            background: rgb(253, 250, 246);
         }

    <style>
    -->

    <style>
    .github-fork-ribbon-wrapper.right {
        position: fixed;
    }
    .github-fork-ribbon {
        background: #090;
    }
    .github-fork-ribbon a:hover {
        background:#0D0;
        color:#fff;
        font-size: 1.1em;
    }
    </style>

    <style>
        @media only screen and (min-width: 40.063em) {
          .top-bar {
            .contain-to-grid .top-bar {
                max-width: 80rem;
            }
          }
        }
        .row {
            max-width: 80rem;
        }
    </style>

    <style>
        .extended-quote,
        .extended-quote-first {
            margin-left: 40px;
            margin-right: 40px;
            font-style: italic;
        }
        .extended-quote-attribution {
            text-align: right;
            margin-right: 100px;
            color: #10B061;
        }

        .extended-quote-first:before {
            content: "\201c";
            float: left;
            font-size: 2.75em;
            font-weight: bold;
            line-height: 0.6em;
            margin-left: -0.6em;
            color: #003b6b;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
    </style>

    <style>
        body {
          position: relative;
        }

        *:not(pre) a > code {
            color: #210DDC;
        }

        *:not(pre) > code {
            background-color: inherit;
            border: none;
            font-weight: normal;
        }

        body div#toc li,
        body div#toc2 li {
            list-style-type: none;
        }

        div#doc-content {
            margin-top: 30px;
        }

        div.documentation-page table.frame-all {
            border-left: none;
            border-right: none;
        }

        body div#toc li.active-region:before,
        body div#toc2 li.active-region:before {
            content: "\00BB \0020";
            margin-left: -12px;
        }

        body div#toc li a.active,
        body div#toc2 li a.active {
            color: red;
        }

        body div#toc.toc,
        body div#toc.toc2 {
            position: fixed;
            left: auto;
            padding-top: 60px;
            z-index: auto;
            background-color: white;
            border-left-color: #eee;
            border-left-style: solid;
            border-right: none;
            min-height: 2000px;
        }

    </style>

    <style>

        @media only screen and (min-width: 768px) {
          #toc.toc2 ul ul { margin-left: -10px; }
        }


        body div#toc .tocify-subheader ul {
            margin-bottom: 0px;
        }

        body div#toc .tocify-subheader li {
            font-size: 14px;
        }
        .tocify li.tocify-item, .tocify ul.tocify-item {
            line-height: 24px;
        }

        body div#toc li.tocify-item.active:before,
        body div#toc2 li.tocify-item.active:before {
            content: "\00BB \0020";
            margin-left: -12px;
        }

        body div#toc li.tocify-item.active a,
        body div#toc2 li.tocify-item.active a {
            color: red;
        }
    </style>

    <style>
        footer {
            margin-top: 1000px;
        }
    </style>

    <style>
        /* overriding colony.css stylesheet */
        .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] {
           /*padding: 1.25em 1.5625em 1.125em 1.5625em;*/
           padding: 0.3em 0.6em 0.25em 0.6em;
        }
        @media only screen and (min-width: 1280px)
        #toc.toc2 {
          /*width: 20em;*/
          width: 25em;
        }

        #doc-content a {
          color: #210DDC;
        }

        .top-bar h1 {
            border-bottom: inherit;
        }

        h2 {
          margin-top: 80px;
        }
        h3 {
          margin-top: 40px;
        }
        h4,h5 {
          margin-top: 30px;
        }

        .admonitionblock.tip > table td.content {
            color: #10B061;
        }
        .admonitionblock.note > table td.content {
            color: #B509AB;
        }
        .admonitionblock.important > table td.content {
            color: #D5810A;
        }

        .admonitionblock .title {
            font-size: larger;
            font-style: italic;
        }

        .imageblock img {
            margin-bottom: 10px;
        }
    </style>

    <style>
        /* from http://ben.balter.com/2014/03/13/pages-anchor-links/ */
        .header-link {
          position: absolute;
          left: -0.5em;
          opacity: 0;

          /*
          -webkit-transition: opacity 0.2s ease-in-out 0.1s;
          -moz-transition: opacity 0.2s ease-in-out 0.1s;
          -ms-transition: opacity 0.2s ease-in-out 0.1s;
          */
        }

        h2:hover .header-link,
        h3:hover .header-link,
        h4:hover .header-link,
        h5:hover .header-link,
        h6:hover .header-link {
          opacity: 1;
        }
    </style>

    <style>
        .top-bar
        {
            -webkit-transition-duration: .5s;
            transition-duration: .5s;

            -webkit-transition-timing-function: cubic-bezier( 0.215, 0.610, 0.355, 1.000 );
            transition-timing-function: cubic-bezier( 0.215, 0.610, 0.355, 1.000 );

            -webkit-transition-property: -webkit-transform;
            transition-property: transform;
        }

        /*
        http://osvaldas.info/auto-hide-sticky-header
        MIT license
        */
        .header--hidden
        {
            -webkit-transform: translateY( -100% );
            -ms-transform: translateY( -100% );
            transform: translateY( -100% );

            transition-duration: .5s;
            transition-timing-function: cubic-bezier( 0.215, 0.610, 0.355, 1.000 );
            -webkit-transition-property: -webkit-transform;
            transition-property: transform;
        }
    </style>

    <style>
        #doc-content a.guide {
            color: white;
        }
    </style>

    <style>
        .tocify {
            margin-top: 80px;
        }
    </style>


</script>

</head>
<body>

<<div class="github-fork-ribbon-wrapper right" style="position: fixed;">
    <div class="github-fork-ribbon">
        <a href="https://github.com/apache/isis#fork-destination-box">Fork me on GitHub</a>
    </div>
</div>


<div class="row">

    <div class="fixed contain-to-grid header">
        <nav class="top-bar" data-topbar role="navigation" style="max-width: 80rem">
            <ul class="title-area">
                <li class="name">
                    <h1>
                        <a href="/index.html">Apache Isis&trade;</a>
                    </h1>
                </li>
                <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
                <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
            </ul>

            <section class="top-bar-section">
                <ul class="right">

                    <li class="has-form">
                       <FORM class="searchbox navbar-form navbar-right" id="searchbox_012614087480249044419:dn-q5gtwxya" action="http://www.google.com/cse">
                        <div class="row collapse">
                            <input type="hidden" name="cx" value="012614087480249044419:dn-q5gtwxya">
                            <INPUT type="hidden" name="cof" value="FORID:0">
                            <INPUT class="form-control" name="q" type="text" placeholder="Search">
                        </div>
                    </FORM>
                     </li>

                </ul>

                <!-- Left Nav Section -->
                <ul class="left">

                    <li><a href="/documentation.html">Documentation</a></li>
                    <li><a href="/downloads.html">Downloads</a></li>
                    <li><a href="/help.html">Help</a></li>
                    <li><a href="/asf.html">@ASF</a></li>

                </ul>

            </section>
        </nav>
    </div>
</div>

<div class="row">

    <div id="doc-content-left" class="large-9 medium-9 columns">


        <div id="doc-content">
          <div class="sect1">
<h2 id="_ugtst">1. Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are going to use Apache Isis for developing complex business-critical applications, then being able to write
automated tests for those applications becomes massively important.  As such Apache Isis treats the topic of testing
very seriously.  (Though we say it ourselves), the framework has support that goes way above what is provided by other
application frameworks.</p>
</div>
<div class="paragraph">
<p>This guide describes those features available to you for testing your Apache Isis application.</p>
</div>
<div class="sect2">
<h3 id="_other_guides">1.1. Other Guides</h3>
<div class="paragraph">
<p>Apache Isis documentation is broken out into a number of user, reference and "supporting procedures" guides.</p>
</div>
<div class="paragraph">
<p>The user guides available are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="ugfun.html">Fundamentals</a></p>
</li>
<li>
<p><a href="ugvw.html">Wicket viewer</a></p>
</li>
<li>
<p><a href="ugvro.html">Restful Objects viewer</a></p>
</li>
<li>
<p><a href="ugsec.html">Security</a></p>
</li>
<li>
<p><a href="#">Testing</a> (this guide)</p>
</li>
<li>
<p><a href="ugbtb.html">Beyond the Basics</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The reference guides are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="rgant.html">Annotations</a></p>
</li>
<li>
<p><a href="rgsvc.html">Domain Services</a></p>
</li>
<li>
<p><a href="rgcfg.html">Configuration Properties</a></p>
</li>
<li>
<p><a href="rgcms.html">Classes, Methods and Schema</a></p>
</li>
<li>
<p><a href="rgmvn.html">Apache Isis Maven plugin</a></p>
</li>
<li>
<p><a href="rgfis.html">Framework Internal Services</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The remaining guides are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="dg.html">Developers' Guide</a> (how to set up a development environment
for Apache Isis and contribute back to the project)</p>
</li>
<li>
<p><a href="cgcom.html">Committers' Guide</a> (release procedures and related practices)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ugtst_aaa">2. Overview</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_unit_tests_vs_integ_tests">2.1. Unit tests vs Integ tests</h3>
<div class="paragraph">
<p>We divide automated tests into two broad categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>unit tests exercise a single unit (usually a method) of a domain object, in isolation. <br></p>
<div class="paragraph">
<p>Dependencies of that object are mocked out.  These are written by a developer and for a developer; they are to ensure that a particular "cog in the machine" works correctly</p>
</div>
</li>
<li>
<p>integration tests exercise the application as a whole, usually focusing on one particular business operation (action). <br></p>
<div class="paragraph">
<p>These are tests that represent the acceptance criteria of some business story; their intent should make sense to the domain expert (even if the domain expert is "non-technical")</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>To put it another way:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Integration tests help ensure that you are <strong><em>building the right system</em></strong></p>
</div>
<div class="paragraph">
<p>Unit tests help ensure that you are <strong><em>building the system right</em></strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_integ_tests_vs_bdd_specs">2.2. Integ tests vs BDD Specs</h3>
<div class="paragraph">
<p>We further sub-divide integration tests into:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>those that are implemented in Java and JUnit (we call these simply <em>"integration tests"</em>)<br></p>
<div class="paragraph">
<p>Even if a domain expert understands the intent of these tests, the actual implementation will be opaque to them.  Also, the only output from the tests is a (hopefully) green CI job</p>
</div>
</li>
<li>
<p>tests (or rather, specifications) that are implemented in a <em>behaviour-driven design</em> (BDD) language such as <a href="https://cucumber.io/">Cucumber</a> (we call these <em>"BDD specs"</em>)<br></p>
<div class="paragraph">
<p>The natural language specification then maps down onto some glue code that is used to drive the application.  But the benefits of taking a BDD approach include the fact that your domain expert will be able to read the tests/specifications, and that when you run the specs, you also get documentation of the application&#8217;s behaviour ("living documentation").</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s up to you whether you use BDD specs for your apps; it will depend on your development process and company culture.  But you if don&#8217;t then you certainly should write integration tests: acceptance criteria for user stories should be automated!</p>
</div>
</div>
<div class="sect2">
<h3 id="_simulated_ui_code_wrapperfactory_code">2.3. Simulated UI (<code>WrapperFactory</code>)</h3>
<div class="paragraph">
<p>When we talk about integration tests/specs here, we mean tests that exercise the domain object logic, through to the actual database.  But we also want the tests to exercise the app from the users&#8217;s perspective, which means including the user interface.</p>
</div>
<div class="paragraph">
<p>For most other frameworks that would require having to test the application in a very heavy weight/fragile fashion using a tool such as <a href="http://docs.seleniumhq.org/">Selenium</a>, driving a web browser to navigate .  In this regard though, Apache Isis has a significant trick up its sleeve.  Because Apache Isis implements the naked objects pattern, it means that the UI is generated automatically from the UI.  This therefore allows for other implementations of the UI.</p>
</div>
<div class="paragraph">
<p>The <a href="rgsvc.html#_rgsvc_api_WrapperFactory"><code>WrapperFactory</code></a> domain service allows a test to wrap domain objects and thus to interact with said objects "as if" through the UI:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/testing/integ-tests.png" alt="integ tests" width="700px">
</div>
</div>
<div class="paragraph">
<p>If the test invokes an action that is disabled, then the wrapper will throw an appropriate exception.  If the action is ok to invoke, it delegates through.</p>
</div>
<div class="paragraph">
<p>What this means is that an Isis application can be tested end-to-end without having to deploy it onto a webserver; the whole app can be tested while running in-memory.  Although integration tests re (necessarily) slower than unit tests, they are not any harder to write (in fact, in some respects they are easier).</p>
</div>
</div>
<div class="sect2">
<h3 id="_dependency_injection">2.4. Dependency Injection</h3>
<div class="paragraph">
<p>Isis provides autowiring dependency injection into every domain object.  This is most useful when writing unit tests; simply mock out the service and inject into the domain object.</p>
</div>
<div class="paragraph">
<p>There are a number of syntaxes supported, but the simplest is to use <code>@javax.inject.Inject</code> annotation; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@javax</span>.inject.Inject
CustomerRepository customers;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Isis can inject into this even if the field has package-level (or even <code>private</code>) visibility.  We recommend that you use package-level visibility, though, so that your unit tests (in the same package as the class under test) are able to inject mocks.</p>
</div>
<div class="paragraph">
<p>Isis does also support a couple of other syntaxes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> setCustomerRepository(CustomerRepository customers) { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> injectCustomerRepository(CustomerRepository customers) { ... }</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Apache Isis also supports automatic dependency injection into integration tests; just declare the service dependency in the usual fashion and it will be automatically injected.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_given_when_then">2.5. Given/When/Then</h3>
<div class="paragraph">
<p>Whatever type of test/spec you are writing, we recommend you follow the given/when/then idiom:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>given</strong> the system is in this state (preconditions)</p>
</li>
<li>
<p><strong>when</strong> I poke it with a stick</p>
</li>
<li>
<p><strong>then</strong> it looks like this (postconditions)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A good test should be 5 to 10 lines long; the test should be there to help you reason about the behaviour of the system.  Certainly if the test becomes more than 20 lines it&#8217;ll be too difficult to understand.</p>
</div>
<div class="paragraph">
<p>The "when" part is usually a one-liner, and in the "then" part there will often be only two or three assertions that you want to make that the system has changed as it should.</p>
</div>
<div class="paragraph">
<p>For unit test the "given" part shouldn&#8217;t be too difficult either: just instantiate the class under test, wire in the appropriate mocks and set up the expectations.  And if there are too many mock expectations to set up, then "listen to the tests" &#8230;&#8203; they are telling you your design needs some work.</p>
</div>
<div class="paragraph">
<p>Where things get difficult though is the "given" for integration tests; which is the topic of the next section&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_fixture_management">2.6. Fixture Management</h3>
<div class="paragraph">
<p>In the previous section we discussed using given/when/then as a form of organizing tests, and why you should keep your tests small.</p>
</div>
<div class="paragraph">
<p>For integration tests though it can be difficult to keep the "given" short; there could be a lot of prerequisite data that needs to exist before you can actually exercise your system.  Moreover, however we do set up that data, but we also want to do so in a way that is resilient to the system changing over time.</p>
</div>
<div class="paragraph">
<p>The solution that Apache Isis provides is a domain service called <a href="rgcms.html#_rgcms_classes_super_FixtureScripts">Fixture Scripts</a>, that defines a pattern and supporting classes to help ensure that the "data setup" for your tests are reusable and maintainable over time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fake_data">2.7. Fake data</h3>
<div class="paragraph">
<p>In any given test there are often quite a few variables involved, to initialize the state of the objects, or to act as arguments for invoking a method, or when asserting on post-conditions.  Sometimes those values are important (eg verifying that an `Order&#8217;s state went from PENDING to SHIPPED, say), but often they aren&#8217;t (a customer&#8217;s name, for example) but nevertheless need to be set up (especially in integration tests).</p>
</div>
<div class="paragraph">
<p>We want our tests to be easily understood, and we want the reader&#8217;s eye to be drawn to the values that are significant and ignore those that are not.</p>
</div>
<div class="paragraph">
<p>One way to do this is to use random (or fake) values for any insignificant data.  This in effect tells the reader that "any value will do".  Moreover, if it turns out that any data won&#8217;t do, and that there&#8217;s some behaviour that is sensitive to the value, then the test will start to flicker, passing and then failing depending on inputs.  This is A Good Thing&#8482;.</p>
</div>
<div class="paragraph">
<p>Apache Isis does not, itself, ship with a fake data library.  However, the <a href="http://github.com/isisaddons/isis-module-fakedata">Isis addons' fakedata</a> module (non-ASF) does provide exactly this capability.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using fake data works very well with fixture scripts; the fixture script can invoke the business action with sensible (fake/random) defaults, and only require that the essential information is passed into it by the test.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_feature_toggles">2.8. Feature Toggles</h3>
<div class="paragraph">
<p>Writing automated tests is just good development practice.  Also good practice is developing on the mainline (master, trunk); so that your continuous integration system really is integrating all code.  Said another way: <a href="http://martinfowler.com/bliki/FeatureBranch.html">don&#8217;t use branches</a>!</p>
</div>
<div class="paragraph">
<p>Sometimes, though, a feature will take longer to implement than your iteration cycle.  In such a case, how do you use continuous integration to keep everyone working on the mainline without revealing a half-implemented feature on your releases?  One option is to use <a href="http://martinfowler.com/bliki/FeatureToggle.html">feature toggle</a>s.</p>
</div>
<div class="paragraph">
<p>Apache Isis does not, itself, ship with a feature toggle library.  However, the <a href="http://github.com/isisaddons/isis-module-togglz">Isis addons' togglz</a> module (non-ASF) does provide exactly this capability.</p>
</div>
<div class="paragraph">
<p>With all that said, let&#8217;s look in detail at the testing features provided by Apache Isis.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ugtst_unit-test-support">3. Unit Test Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Isis Core provides a number of unit test helpers for you to use (if you wish) to unit test your domain objects.</p>
</div>
<div class="sect2">
<h3 id="_ugtst_unit-test-support_contract-tests">3.1. Contract Tests</h3>
<div class="paragraph">
<p>Contract tests ensure that all instances of a particular idiom/pattern that occur within your codebase are implemented correctly.  You could think of them as being a way to enforce a certain type of coding standard.  Implementation-wise they use <a href="https://code.google.com/p/reflections/">Reflections</a> library to scan for classes.</p>
</div>
<div class="sect3">
<h4 id="__code_sortedset_code_s">3.1.1. <code>SortedSet</code>s</h4>
<div class="paragraph">
<p>This contract test automatically checks that all fields of type <code>java.util.Collection</code> are declared as <code>java.util.SortedSet</code>. In other words, it precludes either <code>java.util.List</code> or <code>java.util.Set</code> from being used as a collection.</p>
</div>
<div class="paragraph">
<p>For example, the following passes the contract test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Department</span> {
    <span class="directive">private</span> <span class="predefined-type">SortedSet</span>&lt;Employee&gt; employees = <span class="keyword">new</span> <span class="predefined-type">TreeSet</span>&lt;Employee&gt;();
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>whereas this would not:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SomeDomainObject</span> {
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Employee&gt; employees = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;Employee&gt;();
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If using DataNucleus against an RDBMS (as you probably are) then we strongly recommend that you implement this test, for several reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>first, <code>Set</code>s align more closely to the relational model than do <code>List`s. A `List</code> must have an additional index to specify order.</p>
</li>
<li>
<p>second, <code>SortedSet</code> is preferable to <code>Set</code> because then the order is well-defined and predictable (to an end user, to the programmer).<br></p>
<div class="paragraph">
<p>The <a href="rgcms.html#_rgcms_classes_utility_ObjectContracts"><code>ObjectContracts</code></a>  utility class substantially simplifies the task of implementing <code>Comparable</code> in your domain classes.</p>
</div>
</li>
<li>
<p>third, if the relationship is bidirectional then JDO/Objectstore will automatically maintain the relationship.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use the contract test, subclass <code>SortedSetsContractTestAbstract</code>, specifying the root package to search for domain classes.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SortedSetsContractTestAll</span> <span class="directive">extends</span> SortedSetsContractTestAbstract {

    <span class="directive">public</span> SortedSetsContractTestAll() {
        <span class="local-variable">super</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.estatio.dom</span><span class="delimiter">&quot;</span></span>);
        withLoggingTo(<span class="predefined-type">System</span>.out);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bidirectional">3.1.2. Bidirectional</h4>
<div class="paragraph">
<p>This contract test automatically checks that bidirectional 1:m or 1:1 associations are being maintained correctly (assuming that they follow the <a href="ugfun.html#_ugfun_how-tos_entity-relationships_managed-1-to-m-bidirectional-relationships">mutual registration pattern</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>(If using the JDO objectstore, then) there is generally no need to programmatically maintain 1:m relationships (indeed it may introduce subtle errors). For more details, see <a href="ugfun.html#_ugfun_how-tos_entity-relationships_managed-1-to-m-bidirectional-relationships">here</a>.  Also check out the templates in the developers' guide (<a href="dg.html#_dg_ide_intellij_live-templates">live templates for IntelliJ</a> / <a href="dg.html#_dg_ide_eclipse_editor-templates">editor templates for Eclipse</a>) for further guidance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, suppose that <code>ParentDomainObject</code> and <code>ChildDomainObject</code> have a 1:m relationship (<code>ParentDomainObject#children</code> / <code>ChildDomainObject#parent</code>), and also <code>PeerDomainObject</code> has a 1:1 relationship with itself (<code>PeerDomainObject#next</code> / <code>PeerDomainObject#previous</code>).</p>
</div>
<div class="paragraph">
<p>The following will exercise these relationships:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BidirectionalRelationshipContractTestAll</span>
        <span class="directive">extends</span> BidirectionalRelationshipContractTestAbstract {

    <span class="directive">public</span> BidirectionalRelationshipContractTestAll() {
        <span class="local-variable">super</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.isis.core.unittestsupport.bidir</span><span class="delimiter">&quot;</span></span>,
                ImmutableMap.&lt;<span class="predefined-type">Class</span>&lt;?&gt;,Instantiator&gt;of(
                    ChildDomainObject.class, <span class="keyword">new</span> InstantiatorForChildDomainObject(),
                    PeerDomainObject.class, <span class="keyword">new</span> InstantiatorSimple(PeerDomainObjectForTesting.class)
                ));
        withLoggingTo(<span class="predefined-type">System</span>.out);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first argument to the constructor scopes the search for domain objects; usually this would be something like <code>&quot;com.mycompany.dom&quot;</code>.</p>
</div>
<div class="paragraph">
<p>The second argument provides a map of <code>Instantiator</code> for certain of the domain object types. This has two main purposes. First, for abstract classes, it nominates an alternative concrete class to be instantiated. Second, for classes (such as <code>ChildDomainObject</code>) that are <code>Comparable</code> and are held in a <code>SortedSet</code>), it provides the ability to ensure that different instances are unique when compared against each other. If no <code>Instantiator</code> is provided, then the contract test simply attempts to instantiates the class.</p>
</div>
<div class="paragraph">
<p>If any of the supporting methods (<code>addToXxx()</code>, <code>removeFromXxx()</code>, <code>modifyXxx()</code> or <code>clearXxx()</code>) are missing, the relationship is skipped.</p>
</div>
<div class="paragraph">
<p>To see what&#8217;s going on (and to identify any skipped relationships), use the <code>withLoggingTo()</code> method call. If any assertion fails then the error should be descriptive enough to figure out the problem (without enabling logging).</p>
</div>
<div class="paragraph">
<p>The example tests can be found <a href="https://github.com/apache/isis/tree/master/core/unittestsupport/src/test/java/org/apache/isis/core/unittestsupport/bidir">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_injected_services_method">3.1.3. Injected Services Method</h4>
<div class="paragraph">
<p>It is quite common for some basic services to be injected in a project-specific domain object superclass; for example a <code>ClockService</code> might generally be injected everywhere:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">EstatioDomainObject</span> {
    <span class="annotation">@javax</span>.inject.Inject
    <span class="directive">protected</span> ClockService clockService;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a subclass inadvertantly overrides this method and provides its own <code>ClockService</code> field, then the field in the superclass will never initialized. As you might imagine, <code>NullPointerException</code>s could then arise.</p>
</div>
<div class="paragraph">
<p>This contract test automatically checks that the <code>injectXxx(&#8230;&#8203;)</code> method, to allow for injected services, is not overridable, ie <code>final</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This contract test is semi-obsolete; most of the time you will want to use <code>@javax.inject.Inject</code> on fields rather than the <code>injectXxx()</code> method.  The feature dates from a time before Apache Isis supported the <code>@Inject</code> annotation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use the contract test, , subclass <code>SortedSetsContractTestAbstract</code>, specifying the root package to search for domain classes.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">InjectServiceMethodMustBeFinalContractTestAll</span> <span class="directive">extends</span> InjectServiceMethodMustBeFinalContractTestAbstract {

    <span class="directive">public</span> InjectServiceMethodMustBeFinalContractTestAll() {
        <span class="local-variable">super</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.estatio.dom</span><span class="delimiter">&quot;</span></span>);
        withLoggingTo(<span class="predefined-type">System</span>.out);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_value_objects">3.1.4. Value Objects</h4>
<div class="paragraph">
<p>The <code>ValueTypeContractTestAbstract</code> automatically tests that a custom value type implements <code>equals()</code> and <code>hashCode()</code> correctly.</p>
</div>
<div class="paragraph">
<p>For example, testing JDK&#8217;s own <code>java.math.BigInteger</code> can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ValueTypeContractTestAbstract_BigIntegerTest</span> <span class="directive">extends</span> ValueTypeContractTestAbstract&lt;<span class="predefined-type">BigInteger</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">BigInteger</span>&gt; getObjectsWithSameValue() {
        <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.asList(<span class="keyword">new</span> <span class="predefined-type">BigInteger</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> <span class="predefined-type">BigInteger</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>));
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">BigInteger</span>&gt; getObjectsWithDifferentValue() {
        <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.asList(<span class="keyword">new</span> <span class="predefined-type">BigInteger</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example unit tests can be found <a href="https://github.com/apache/isis/tree/master/core/unittestsupport/src/test/java/org/apache/isis/core/unittestsupport/value">here</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ugtst_unit-test-support_jmock-extensions">3.2. JMock Extensions</h3>
<div class="paragraph">
<p>As noted earlier, for unit tests we tend to use <a href="http://www.jmock.org">JMock</a> as our mocking library.  The usual given/when/then format gets an extra step:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>given</strong> the system is in this state</p>
</li>
<li>
<p><strong>expecting</strong> these interactions (set up the mock expectations here)</p>
</li>
<li>
<p><strong>when</strong> I poke it with a stick</p>
</li>
<li>
<p><strong>then</strong> these state changes and interactions with Mocks should have occurred.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If using JMock then the interactions (in the "then") are checked automatically by a JUnit rule.  However, you probably will still have some state changes to assert upon.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Distinguish between queries vs mutators</div>
<div class="paragraph">
<p>For mock interactions that simply retrieve some data, your test should not need to verify that it occurred.  If the system were to be refactored and starts caching some data, you don&#8217;t really want your tests to start breaking because they are no longer performing a query that once they did.  If using JMock API this means using the <code>allowing(..)</code> method to set up the expectation.</p>
</div>
<div class="paragraph">
<p>On the other hand mocks that mutate the state of the system you probably should assert have occurred.  If using JMock this typically means using the <code>oneOf(&#8230;&#8203;)</code> method.</p>
</div>
<div class="paragraph">
<p>For more tips on using JMock and mocking in general, check out the <a href="http://www.growing-object-oriented-software.com/">GOOS</a> book, written by JMock&#8217;s authors, Steve Freeman and Nat Pryce and also <a href="http://natpryce.com/articles.html">Nat&#8217;s blog</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Apache Isis' unit test support provides <code>JUnitRuleMockery2</code> which is an extension to the <a href="http://www.jmock.org/">JMock</a>'s <code>JunitRuleMockery</code>.  It provides a simpler API and also providing support for autowiring.</p>
</div>
<div class="paragraph">
<p>For example, here we see that the class under test, an instance of <code>CollaboratingUsingSetterInjection</code>, is automatically wired up with its <code>Collaborator</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JUnitRuleMockery2Test_autoWiring_setterInjection_happyCase</span> {

    <span class="annotation">@Rule</span>
    <span class="directive">public</span> JUnitRuleMockery2 context = JUnitRuleMockery2.createFor(Mode.INTERFACES_AND_CLASSES);

    <span class="annotation">@Mock</span>
    <span class="directive">private</span> Collaborator collaborator;

    <span class="annotation">@ClassUnderTest</span>
    <span class="directive">private</span> CollaboratingUsingSetterInjection collaborating;

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> wiring() {
        assertThat(collaborating.collaborator, is(not(nullValue())));
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Isis also includes (and automatically uses) a <a href="http://www.javassist.org">Javassist</a>-based implementation of JMock&#8217;s <a href="http://www.jmock.org/mocking-classes.html"><code>ClassImposteriser</code></a> interface, so that you can mock out concrete classes as well as interfaces.  We&#8217;ve provided this rather than JMock&#8217;s own cglib-based implementation (which is problematic for us given its own dependencies on <a href="http://asm.ow2.org/">asm</a>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The example tests can be found <a href="https://github.com/apache/isis/tree/master/core/unittestsupport/src/test/java/org/apache/isis/core/unittestsupport/jmocking">here</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_ugtst_unit-test-support_soap-fake-server-junit-rule">3.3. SOAP Fake Endpoints</h3>
<div class="paragraph">
<p>No man is an island, and neither are most applications.  Chances are that at some point you may need to integrate your Apache Isis application to other external systems, possibly using old-style SOAP web services.  The SOAP client in this case could be a domain service within your app, or it might be externalized, eg invoked through a scheduler or using <a href="http://camel.apache.org">Apache Camel</a>.</p>
</div>
<div class="paragraph">
<p>While you will want to (of course) perform manual system testing/UAT with a test instance of that external system, it&#8217;s also useful to be able to perform unit testing of your SOAP client component.</p>
</div>
<div class="paragraph">
<p>The <code>SoapEndpointPublishingRule</code> is a simple JUnit rule that allows you to run a fake SOAP endpoint within an unit test.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The (non-ASF) <a href="http://github.com/isisaddons/isis-module-publishmq">Isis addons' publishmq</a> module provides a full example of how to integrate and test an Apache Isis application with a (faked out) external system.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="__code_soapendpointpublishingrule_code">3.3.1. <code>SoapEndpointPublishingRule</code></h4>
<div class="paragraph">
<p>The idea behind this rule is that you write a fake server endpoint that implements the same WSDL contract as the "real" external system does, but which also exposes additional API to specify responses (or throw exceptions) from SOAP calls.  It also typically records the requests and allows these to be queried.</p>
</div>
<div class="paragraph">
<p>In its setup your unit test and gets the rule to instantiate and publish that fake server endpoint, and then obtains a reference to that server endpoint.  It also instantiates the SOAP client, pointing it at the address (that is, a URL) that the fake server endpoint is running on.  This way the unit test has control of both the SOAP client and server: the software under test and its collaborator.</p>
</div>
<div class="paragraph">
<p>In the test methods your unit test sets up expectations on your fake server, and then exercises the SOAP client.  The SOAP client calls the fake server, which then responds accordingly.  The test can then assert that all expected interactions have occurred.</p>
</div>
<div class="paragraph">
<p>So that tests don&#8217;t take too long to run, the rule puts the fake server endpoints onto a thread-local.  Therefore the unit tests should clear up any state on the fake server endpoints.</p>
</div>
<div class="paragraph">
<p>Your unit test uses the rule by specifying the endpoint class (must have a no-arg constructor):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">FakeExternalSystemEndpointRuleTest</span> {
    <span class="annotation">@Rule</span>
    <span class="directive">public</span> SoapEndpointPublishingRule serverRule =
        <span class="keyword">new</span> SoapEndpointPublishingRule(FakeExternalSystemEndpoint.class);         <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> FakeExternalSystemEndpoint fakeServerEndpoint;
    <span class="directive">private</span> DemoObject externalSystemContract;                                    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="annotation">@Before</span>
    <span class="directive">public</span> <span class="type">void</span> setUp() <span class="directive">throws</span> <span class="exception">Exception</span> {
        fakeServerEndpoint =
            serverRule.getEndpointImplementor(FakeExternalSystemEndpoint.class);  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="directive">final</span> <span class="predefined-type">String</span> endpointAddress =
            serverRule.getEndpointAddress(FakeExternalSystemEndpoint.class);      <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="directive">final</span> DemoObjectService externalSystemService =                           <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="keyword">new</span> DemoObjectService(ExternalSystemWsdl.getWsdl());              <i class="conum" data-value="6"></i><b>(6)</b>
        externalSystemContract = externalSystemService.getDemoObjectOverSOAP();
        BindingProvider provider = (BindingProvider) externalSystemContract;
        provider.getRequestContext().put(
                BindingProvider.ENDPOINT_ADDRESS_PROPERTY,
                endpointAddress)
        );
    }
    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> happy_case() <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">// given</span>
        <span class="directive">final</span> Update update = <span class="keyword">new</span> Update();                              <i class="conum" data-value="7"></i><b>(7)</b>
        ...
        <span class="comment">// expect</span>
        final UpdateResponse response = <span class="keyword">new</span> UpdateResponse();            <i class="conum" data-value="8"></i><b>(8)</b>
        ...
        fakeServerEndpoint.control().setResponse(updateResponse);
        <span class="comment">// when</span>
        PostResponse response = externalSystemContract.post(update);     <i class="conum" data-value="9"></i><b>(9)</b>
        <span class="comment">// then</span>
        <span class="directive">final</span> <span class="predefined-type">List</span>&lt;Update&gt; updates =                                     <i class="conum" data-value="10"></i><b>(10)</b>
            fakeServerEndpoint.control().getUpdates();
        ...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>specify the class that implements the endpoint (must have a no-arg constructor)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the SOAP contract as defined in WSDL and generated by wsdl2java</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>get hold of the fake server-side endpoint from the rule&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>&#8230;&#8203; and its endpoint address</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>use factory (also generated by wsdl2java) to create client-side endpoint</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>getWsdl()</code> is a utility method to return a URL for the WSDL (eg from the classpath)</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>create a request object in order to invoke the SOAP web service</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>instruct the fake server endpoint how to respond</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>invoke the web service</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>check the fake server endpoint was correctly invoked etc.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The rule can also host multiple endpoints; just provide multiple classes in the constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Rule</span>
<span class="directive">public</span> SoapEndpointPublishingRule serverRule =
                <span class="keyword">new</span> SoapEndpointPublishingRule(
                    FakeCustomersEndpoint.class,
                    FakeOrdersEndpoint.class,
                    FakeProductsEndpoint.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To lookup a particular endpoint, specify its type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">FakeProductsEndpoint fakeProductsServerEndpoint =
            serverRule.getPublishedEndpoint(FakeProductsEndpoint.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The endpoint addresses that the server endpoints run on are determined automatically.  If you want more control, then you can call one of <code>SoapEndpointPublishingRule</code>'s overloaded constructors, passing in one or more <code>SoapEndpointSpec</code> instances.</p>
</div>
</div>
<div class="sect3">
<h4 id="_xml_marshalling_support">3.3.2. XML Marshalling Support</h4>
<div class="paragraph">
<p>Apache Isis' unit testing support also provides helper <code>JaxbUtil</code> and <code>JaxbMatchers</code> classes.  These are useful if you have exampler XML-serialized representations of the SOAP requests and response payloads and want to use these within your tests.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ugtst_unit-test-support_maven-configuration">3.4. Maven Configuration</h3>
<div class="paragraph">
<p>Apache Isis' unit test support is automatically configured if you use the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a>.  To set it up manually, update the <code>pom.xml</code> of your domain object model module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.isis.core<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>isis-core-unittestsupport<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Normally <code>test</code>; usual Maven scoping rules apply.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We also recommend that you configure the <code>maven-surefire-plugin</code> to pick up the following class patterns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.10<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;configuration&gt;</span>
        <span class="tag">&lt;includes&gt;</span>
            <span class="tag">&lt;include&gt;</span>**/*Test.java<span class="tag">&lt;/include&gt;</span>
            <span class="tag">&lt;include&gt;</span>**/*Test_*.java<span class="tag">&lt;/include&gt;</span>
            <span class="tag">&lt;include&gt;</span>**/*Spec*.java<span class="tag">&lt;/include&gt;</span>
        <span class="tag">&lt;/includes&gt;</span>
        <span class="tag">&lt;excludes&gt;</span>
            <span class="tag">&lt;exclude&gt;</span>**/Test*.java<span class="tag">&lt;/exclude&gt;</span>
            <span class="tag">&lt;exclude&gt;</span>**/*ForTesting.java<span class="tag">&lt;/exclude&gt;</span>
            <span class="tag">&lt;exclude&gt;</span>**/*Abstract*.java<span class="tag">&lt;/exclude&gt;</span>
        <span class="tag">&lt;/excludes&gt;</span>
        <span class="tag">&lt;useFile&gt;</span>true<span class="tag">&lt;/useFile&gt;</span>
        <span class="tag">&lt;printSummary&gt;</span>true<span class="tag">&lt;/printSummary&gt;</span>
        <span class="tag">&lt;outputDirectory&gt;</span>${project.build.directory}/surefire-reports<span class="tag">&lt;/outputDirectory&gt;</span>
    <span class="tag">&lt;/configuration&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ugtst_integ-test-support">4. Integration Test Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As discussed in the introductory overview of this chapter, Apache Isis allows you to integration test your domain objects from within JUnit.  There are several parts to this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>configuring the Apache Isis runtime so it can be bootstrapped (mostly boilerplate)</p>
</li>
<li>
<p>defining a base class to perform said bootstrapping</p>
</li>
<li>
<p>using fixture scripts to set up the app</p>
</li>
<li>
<p>using <code>WrapperFactory</code> so that the UI can be simulated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;ll get to all that shortly, but let&#8217;s start by taking a look at what a typical integration test looks like.</p>
</div>
<div class="sect2">
<h3 id="_ugtst_integ-test-support_typical-usage">4.1. Typical Usage</h3>
<div class="paragraph">
<p>This example adapted from the <a href="http://github.com/isisaddons/isis-app-todoapp">Isis addons' todoapp</a> (non-ASF).  The code we want to test (simplified) is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ToDoItem</span> ... {

    <span class="directive">private</span> <span class="type">boolean</span> complete;
    <span class="annotation">@Property</span>( editing = Editing.DISABLED )
    <span class="directive">public</span> <span class="type">boolean</span> isComplete() {
        <span class="keyword">return</span> complete;
    }
    <span class="directive">public</span> <span class="type">void</span> setComplete(<span class="directive">final</span> <span class="type">boolean</span> complete) {
        <span class="local-variable">this</span>.complete = complete;
    }

    <span class="annotation">@Action</span>()
    <span class="directive">public</span> ToDoItem completed() {
        setComplete(<span class="predefined-constant">true</span>);
        ...
        return <span class="local-variable">this</span>;
    }
    <span class="directive">public</span> <span class="predefined-type">String</span> disableCompleted() {
        <span class="keyword">return</span> isComplete() ? <span class="string"><span class="delimiter">&quot;</span><span class="content">Already completed</span><span class="delimiter">&quot;</span></span> : <span class="predefined-constant">null</span>;
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We typically put the bootstrapping of Apache Isis into a superclass (<code>AbstractToDoIntegTest</code> below), then subclass as required.</p>
</div>
<div class="paragraph">
<p>For this test (of the "completed()" action) we need an instance of a <code>ToDoItem</code> that is not yet complete.  Here&#8217;s the setup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ToDoItemIntegTest</span> <span class="directive">extends</span> AbstractToDoIntegTest {

    <span class="annotation">@Inject</span>
    FixtureScripts fixtureScripts;                              <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@Inject</span>
    ToDoItems toDoItems;                                        <i class="conum" data-value="2"></i><b>(2)</b>
    ToDoItem toDoItem;                                          <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="annotation">@Before</span>
    <span class="directive">public</span> <span class="type">void</span> setUp() <span class="directive">throws</span> <span class="exception">Exception</span> {
        RecreateToDoItemsForCurrentUser fixtureScript =         <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="keyword">new</span> RecreateToDoItemsForCurrentUser();
        fixtureScripts.runFixtureScript(fixtureScript, <span class="predefined-constant">null</span>);
        <span class="directive">final</span> <span class="predefined-type">List</span>&lt;ToDoItem&gt; all = toDoItems.notYetComplete();  <i class="conum" data-value="5"></i><b>(5)</b>
        toDoItem = wrap(all.get(<span class="integer">0</span>));                            <i class="conum" data-value="6"></i><b>(6)</b>
    }
    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the <a href="rgcms.html#_rgcms_classes_super_FixtureScripts"><code>FixtureScripts</code></a> domain service is injected, providing us with the ability to run fixture scripts</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>likewise, an instance of the <code>ToDoItems</code> domain service is injected.  We&#8217;ll use this to lookup&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the object under test, held as a field</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>the fixture script for this test; it deletes all existing todo items (for the current user only) and then recreates them</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>we lookup one of the just-created todo items&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>and then wrap it so that our interactions with it are as if through the UI</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following code tests the happy case, that a not-yet-completed <code>ToDoItem</code> can be completed by invoking the <code>completed()</code> action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ToDoItemIntegTest</span> ... {
    ...
    public <span class="directive">static</span> <span class="type">class</span> <span class="class">Completed</span> <span class="directive">extends</span> ToDoItemIntegTest { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="annotation">@Test</span>
        <span class="directive">public</span> <span class="type">void</span> happyCase() <span class="directive">throws</span> <span class="exception">Exception</span> {
            <span class="comment">// given</span>
            assertThat(toDoItem.isComplete()).isFalse();      <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="comment">// when</span>
            toDoItem.completed();
            <span class="comment">// then</span>
            assertThat(toDoItem.isComplete()).isTrue();
        }
        ...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the idiom we follow is to use nested static classes to identify the class responsibility being tested</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the <a href="http://github.com/isisaddons/isis-app-todoapp">todoapp</a> uses <a href="http://joel-costigliola.github.io/assertj">AssertJ</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What about when a todo item is already completed?  The <code>disableCompleted()</code> method in the class says that it shouldn&#8217;t be allowed (the action would be greyed out in the UI with an appropriate tooltip).  The following test verifies this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span class="annotation">@Test</span>
        <span class="directive">public</span> <span class="type">void</span> cannotCompleteIfAlreadyCompleted() <span class="directive">throws</span> <span class="exception">Exception</span> {
            <span class="comment">// given</span>
            unwrap(toDoItem).setComplete(<span class="predefined-constant">true</span>);                     <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="comment">// expect</span>
            expectedExceptions.expectMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Already completed</span><span class="delimiter">&quot;</span></span>);  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="comment">// when</span>
            toDoItem.completed();
        }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>we unwrap the domain object in order to set its state directly</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the expectedExceptions <a href="http://junit.org/apidocs/org/junit/rules/ExpectedException.html">JUnit rule</a> (defined by a superclass) verifies that the appropiate exception is indeed thrown (in the "when")</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And what about the fact that the underlying "complete" property is disabled (the <code>@Disabled</code> annotation?).  If the <code>ToDoItem</code> is put into edit mode in the UI, the complete checkbox should remain read-only.  Here&#8217;s a verify similar test that verifies this also:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span class="annotation">@Test</span>
        <span class="directive">public</span> <span class="type">void</span> cannotSetPropertyDirectly() <span class="directive">throws</span> <span class="exception">Exception</span> {
            <span class="comment">// expect</span>
            expectedExceptions.expectMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Always disabled</span><span class="delimiter">&quot;</span></span>);  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="comment">// when</span>
            toDoItem.setComplete(<span class="predefined-constant">true</span>);
        }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>again we use the exceptedExceptions rule.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_ugtst_integ-test-support_bootstrapping">4.2. Bootstrapping</h3>
<div class="paragraph">
<p>Integration tests instantiate an Apache Isis "runtime" (as a singleton) within a JUnit test.  Because (depending on the size of your app) it takes a little time to bootstrap Apache Isis, the framework caches the runtime on a thread-local from one test to the next.</p>
</div>
<div class="paragraph">
<p>Nevertheless, we do need to bootstrap the runtime for the very first test.</p>
</div>
<div class="paragraph">
<p>As of 1.9.0 the bootstrapping of integration tests and webapps has been simplified through the <a href="rgcms.html#_rgcms_classes_AppManifest-bootstrapping"><code>AppManifest</code></a> class.  Since this isn&#8217;t mandatory, for now we present both techniques.</p>
</div>
<div class="paragraph">
<p>The example code in this section is taken from the app generated by the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a>.</p>
</div>
<div class="sect3">
<h4 id="_system_initializer">4.2.1. System Initializer</h4>
<div class="paragraph">
<p>The bootstrapping itself is performed by a "system initializer" class.  This is responsible for instantiating the Apache Isis runtime, and binding it to a thread-local.</p>
</div>
<div class="sect4">
<h5 id="_1_9_0_code_appmanifest_code">1.9.0 (<code>AppManifest</code>)</h5>
<div class="paragraph">
<p>As of 1.9.0, the code (using <code>AppManifest</code>) is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DomainAppSystemInitializer</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> initIsft() {
        IsisSystemForTest isft = IsisSystemForTest.getElseNull();
        <span class="keyword">if</span>(isft == <span class="predefined-constant">null</span>) {
            isft = <span class="keyword">new</span> IsisSystemForTest.Builder()
                    .withLoggingAt(org.apache.log4j.Level.INFO)
                    .with(<span class="keyword">new</span> DomainAppAppManifest())
                    .with(<span class="keyword">new</span> IsisConfigurationForJdoIntegTests())
                    .build()
                    .setUpSystem();
            IsisSystemForTest.set(isft);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>DomainAppAppManifest</code> in turn is defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DomainAppAppManifest</span> <span class="directive">implements</span> AppManifest {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Class</span>&lt;?&gt;&gt; getModules() {
        <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.asList(
                domainapp.dom.DomainAppDomainModule.class,
                domainapp.fixture.DomainAppFixtureModule.class,
                domainapp.app.DomainAppAppModule.class
        );
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Further details on bootstrapping with the <code>AppManifest</code> can be found in the <a href="rgcms.html#_rgcms_classes_AppManifest-bootstrapping">reference guide</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_1_8_0_and_earlier">1.8.0 and earlier</h5>
<div class="paragraph">
<p>Prior to 1.9.0, the services and entities had to be specified in two separate locations.  The suggested way to do this was to introduce a subclass of the <code>IsisSystemForTest.Builder</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">DomainAppSystemBuilder</span> <span class="directive">extends</span> IsisSystemForTest.Builder {      <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> DomainAppSystemBuilder() {
        withLoggingAt(org.apache.log4j.Level.INFO);
        with(testConfiguration());
        with(<span class="keyword">new</span> DataNucleusPersistenceMechanismInstaller());                        <i class="conum" data-value="2"></i><b>(2)</b>
        withServicesIn( <span class="string"><span class="delimiter">&quot;</span><span class="content">domainapp</span><span class="delimiter">&quot;</span></span> );                                               <i class="conum" data-value="3"></i><b>(3)</b>
    }
    <span class="directive">private</span> <span class="directive">static</span> IsisConfiguration testConfiguration() {
        <span class="directive">final</span> IsisConfigurationForJdoIntegTests testConfiguration =
            <span class="keyword">new</span> IsisConfigurationForJdoIntegTests();                                 <i class="conum" data-value="4"></i><b>(4)</b>
        testConfiguration.addRegisterEntitiesPackagePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">domainapp.dom.modules</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="keyword">return</span> testConfiguration;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>subclass the framework-provided <code>IsisSystemForTest.Builder</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>equivalent to <code>isis.persistor=datanucleus</code> in <code>isis.properties</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>specify the <code>isis.services</code> key in <code>isis.properties</code> (where "domainapp" is the base package for all classes within the app)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>IsisConfigurationForJdoIntegTests</code> has pre-canned configuration for using an in-memory HSQLDB and other standard settings; more on this below.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>equivalent to <code>isis.persistor.datanucleus.RegisterEntities.packagePrefix</code> key (typically in <code>persistor_datanucleus.properties</code>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This builder could then be used within the system initializer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DomainAppSystemInitializer</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> initIsft() {
        IsisSystemForTest isft = IsisSystemForTest.getElseNull();
        <span class="keyword">if</span>(isft == <span class="predefined-constant">null</span>) {
            isft = <span class="keyword">new</span> DomainAppSystemBuilder()    <i class="conum" data-value="1"></i><b>(1)</b>
                            .build()
                            .setUpSystem();
            IsisSystemForTest.set(isft);           <i class="conum" data-value="2"></i><b>(2)</b>
        }
    }
    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">DomainAppSystemBuilder</span>
        <span class="directive">extends</span> IsisSystemForTest.Builder { ... }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>instantiates and initializes the Apache Isis runtime (the <code>IsisSystemForTest</code> class)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>binds the runtime to a thread-local.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_isisconfigurationforjdointegtests">IsisConfigurationForJdoIntegTests</h5>
<div class="paragraph">
<p>Integration tests are configured programmatically, with a default set of properties to bootstrap the JDO/DataNucleus objectstore using an HSQLDB in-memory database.</p>
</div>
<div class="paragraph">
<p>To remove a little bit of boilerplate, the <code>IsisConfigurationForJdoIntegTests</code> class (in the <code>org.apache.isis.objectstore.jdo.datanucleus</code> package) can be used to bootstrap the application.  If necessary, this class can be subclassed to override these defaults.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Default Configuration Properties for Integration Tests</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.</code><br>
<code>javax.jdo.option.ConnectionURL</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdbc:hsqldb:mem:test</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>JDBC URL</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.</code><br>
<code>javax.jdo.option.ConnectionDriverName</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.hsqldb.jdbcDriver</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>JDBC Driver</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.</code><br>
<code>javax.jdo.option.ConnectionUserName</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sa</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Username</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.</code><br>
<code>javax.jdo.option.ConnectionPassword</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;empty string&gt;</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Password</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.</code><br>
<code>datanucleus.schema.autoCreateAll</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Recreate DB for each test run (an in-memory database)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.</code><br>
<code>datanucleus.schema.validateAll</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Disable validations (minimize bootstrap time)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.</code><br>
<code>datanucleus.persistenceByReachabilityAtCommit</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>As per WEB-INF/persistor_datanucleus.properties</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.</code><br>
<code>datanucleus.identifier.case</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MixedCase</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>As per WEB-INF/persistor_datanucleus.properties</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.</code><br>
<code>datanucleus.cache.level2.type</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>As per WEB-INF/persistor_datanucleus.properties</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.</code><br>
<code>datanucleus.cache.level2.mode</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ENABLE_SELECTIVE</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>As per WEB-INF/persistor_datanucleus.properties</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.datanucleus.</code><br>
<code>install-fixtures</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Automatically install any fixtures that might have been registered</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.persistor.</code><br>
<code>enforceSafeSemantics</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>isis.deploymentType</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">server_prototype</p></td>
<td class="tableblock halign-left valign-top"><div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_abstract_class">4.2.2. Abstract Class</h4>
<div class="paragraph">
<p>We recommend defining a base class for all your other classes to integration classes to inherit from.  The main responsibility of this class is tocall the system initializer, described earlier.  We only need the initialization to be performed once, so this call is performed in a <code>@BeforeClass</code> hook.</p>
</div>
<div class="paragraph">
<p>The code below shows the general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">DomainAppIntegTest</span> {
    <span class="annotation">@BeforeClass</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> initClass() {
        org.apache.log4j.PropertyConfigurator.configure(<span class="string"><span class="delimiter">&quot;</span><span class="content">logging.properties</span><span class="delimiter">&quot;</span></span>);   <i class="conum" data-value="1"></i><b>(1)</b>
        DomainAppSystemInitializer.initIsft();                                   <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="keyword">new</span> ScenarioExecutionForIntegration();                                   <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ensure that logging messages don&#8217;t get swallowed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>initialize the Apache Isis runtime</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>primarily exists to support the writing of <a href="#_ugtst_bdd-spec-support">BDD specifications</a>, but also enables finer-grained management of sessions/transactions (discussed below).</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_ugtst_integ-test-support_bootstrapping_IntegrationTestAbstract"><code>IntegrationTestAbstract</code></h5>
<div class="paragraph">
<p>In fact, we recommend that your base class inherit from Apache Isis' <code>IntegrationTestAbstract</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">DomainAppIntegTest</span> <span class="directive">extends</span> IntegrationTestAbstract {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although not mandatory, this provides a number of helper/convenience methods and JUnit rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Rule</span>
    <span class="directive">public</span> IsisTransactionRule isisTransactionRule =                         <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="keyword">new</span> IsisTransactionRule();
    <span class="annotation">@Rule</span>
    <span class="directive">public</span> JUnitRuleMockery2 context =                                       <i class="conum" data-value="2"></i><b>(2)</b>
        JUnitRuleMockery2.createFor(Mode.INTERFACES_AND_CLASSES);
    <span class="annotation">@Rule</span>
    <span class="directive">public</span> ExpectedException expectedExceptions =                            <i class="conum" data-value="3"></i><b>(3)</b>
        ExpectedException.none();
    <span class="annotation">@Rule</span>
    <span class="directive">public</span> ExceptionRecognizerTranslate exceptionRecognizerTranslations =    <i class="conum" data-value="4"></i><b>(4)</b>
        ExceptionRecognizerTranslate.create();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ensures an Apache Isis session/transaction running for each test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>sets up a JMock context (using Apache Isis' extension to JMock as described in <a href="#_ugtst_unit-test-support_jmock-extensions">JMock Extensions</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>standard JUnit rule for writing tests that throw exceptions</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>to capture messages that require translation, as described in <a href="ugbtb.html#_ugbtb_i18n">i18 support</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All of these rules could be inlined in your own base class; as we say, they are a convenience.</p>
</div>
<div class="paragraph">
<p>The <code>IntegrationTestAbstract</code> also provides a number of helper/convenience methods, though most of these have been
deprecated because the functionality they expose is now readily accessible through various domain services; most
notably these are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="rgsvc.html#_rgsvc_api_WrapperFactory"><code>WrapperFactory</code></a><br></p>
<div class="paragraph">
<p>to wrap objects simulating interaction through the user interface)</p>
</div>
</li>
<li>
<p><a href="rgsvc.html#_rgsvc_api_TransactionService"><code>TransactionService</code></a><br></p>
<div class="paragraph">
<p>most commonly used to commit changes after the fixture setup) and,</p>
</div>
</li>
<li>
<p><a href="rgsvc.html#_rgsvc_api_SessionManagementService"><code>SessionManagementService</code></a><br></p>
<div class="paragraph">
<p>for tests that check interactions over multiple separate sessions.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ugtst_integ-test-support_wrapper-factory">4.3. Wrapper Factory</h3>
<div class="paragraph">
<p>The <a href="rgsvc.html#_rgsvc_api_WrapperFactory"><code>WrapperFactory</code></a> service is responsible for wrapping a domain object in a dynamic proxy, of the same type as the object being proxied.  And the role of this wrapper is to simulate the UI.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>WrapperFactory</code> uses <a href="http://www.javassist.org">javassist</a> to perform its magic; this is the same technology that ORMs such as <a href="http://hibernate.org/">Hibernate</a> use to manage lazy loading/dirty tracking (DataNucleus uses a different mechanism).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It does this by allowing through method invocations that would be allowed if the user were interacting with the domain object through one of the viewers, but throwing an exception if the user attempts to interact with the domain object in a way that would not be possible if using the UI.</p>
</div>
<div class="paragraph">
<p>The mechanics are as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the integration test calls the <code>WrapperFactory</code> to obtain a wrapper for the domain object under test.  This is usually done in the test&#8217;s <code>setUp()</code> method.</p>
</li>
<li>
<p>the test calls the methods on the wrapper rather than the domain object itself</p>
</li>
<li>
<p>the wrapper performs a reverse lookup from the method invoked (a regular <code>java.lang.reflect.Method</code> instance) into the Apache Isis metamodel</p>
</li>
<li>
<p>(like a viewer), the wrapper then performs the "see it/use it/do it" checks, checking that the member is visible, that it is enabled and (if there are arguments) that the arguments are valid</p>
</li>
<li>
<p>if the business rule checks pass, then the underlying member is invoked.  Otherwise an exception is thrown.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The type of exception depends upon what sort of check failed.  It&#8217;s straightforward enough: if the member is invisible then a <code>HiddenException</code> is thrown; if it&#8217;s not usable then you&#8217;ll get a <code>DisabledException</code>, if the args are not valid then catch an <code>InvalidException</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/testing/wrapper-factory.png" alt="wrapper factory" width="600px">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s look in a bit more detail at what the test can do with the wrapper.</p>
</div>
<div class="sect3">
<h4 id="_wrapping_and_unwrapping">4.3.1. Wrapping and Unwrapping</h4>
<div class="paragraph">
<p>Wrapping a domain object is very straightforward; simply call <code>WrapperFactory#wrap(&#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Customer customer = ...;
Customer wrappedCustomer = wrapperFactory.wrap(wrappedCustomer);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Going the other way&#8201;&#8212;&#8201;getting hold of the underlying (wrapped) domain object&#8201;&#8212;&#8201;is just as easy; just call <code>WrapperFactory#unwrap(&#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Customer wrappedCustomer = ...;
Customer customer = wrapperFactory.unwrap(wrappedCustomer);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you prefer, you also can get the underlying object from the wrapper itself, by downcasting to <code>WrappingObject</code> and calling <code>__isis_wrapped()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Customer wrappedCustomer = ...;
Customer customer = (Customer)((WrappingObject)wrappedCustomer).__isis_wrapped());</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re not sure that&#8217;s any easier (in fact we&#8217;re certain it looks rather obscure).  Stick with calling <code>unwrap(&#8230;&#8203;)</code>!</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_wrapper">4.3.2. Using the wrapper</h4>
<div class="paragraph">
<p>As the wrapper is intended to simulate the UI, only those methods that correspond to the "primary" methods of the domain object&#8217;s members are allowed to be called.  That means:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for <strong><em>object properties</em></strong> the test can call the getter or setter method</p>
</li>
<li>
<p>for <strong><em>object collections</em></strong> the test can call the getter. <br></p>
<div class="paragraph">
<p>If there is a supporting <code>addTo&#8230;&#8203;()</code> or <code>removeFrom&#8230;&#8203;()</code> method, then these can be called.  It can also call <code>add(&#8230;&#8203;)</code> or <code>remove(&#8230;&#8203;)</code> on the collection (returned by the gettter) itself.<br></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this respect the wrapper is more functional than the <a href="ugvw.html">Wicket viewer</a> (which does not expose the ability to mutate collections directly).</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>for <strong><em>object actions</em></strong> the test can call the action method itself.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As a convenience, we also allow the test to call any <code>default&#8230;&#8203;()</code>,<code>choices&#8230;&#8203;()</code> or <code>autoComplete&#8230;&#8203;()</code> method.  These are often useful for obtaining a valid value to use.</p>
</div>
<div class="paragraph">
<p>What the test can&#8217;t call is any of the remaining supporting methods, such as <code>hide&#8230;&#8203;()</code>, <code>disable&#8230;&#8203;()</code> or <code>validate&#8230;&#8203;()</code>.  That&#8217;s because their value is implied by the exception being thrown.</p>
</div>
<div class="paragraph">
<p>The wrapper <em>does</em> also allow the object&#8217;s <code>title()</code> method or its  <code>toString()</code> , however this is little use for objects whose title is built up using the <code>@Title</code> annotation.  Instead, we recommend that your test verifies an object&#8217;s title by calling <code>DomainObjectContainer#titleOf(&#8230;&#8203;)</code> method.</p>
</div>
</div>
<div class="sect3">
<h4 id="_firing_domain_events">4.3.3. Firing Domain Events</h4>
<div class="paragraph">
<p>As well as enforcing business rules, the wrapper has another important feature, namely that it will cause domain events to be fired.</p>
</div>
<div class="paragraph">
<p>For example, if we have an action annotated with <code>@Action(domainEvent=&#8230;&#8203;</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ToDoItem</span> ... {
    <span class="annotation">@Action</span>(
            domainEvent =CompletedEvent.class
    )
    <span class="directive">public</span> ToDoItem completed() { ... }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>then invoking the action through the proxy will cause the event (<code>CompletedEvent</code> above) to be fired to any subscribers.  A test might therefore look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span>
<span class="directive">private</span> EventBusService eventBusService;                                          <i class="conum" data-value="1"></i><b>(1)</b>

<span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> subscriberReceivesEvents() <span class="directive">throws</span> <span class="exception">Exception</span> {

    <span class="comment">// given</span>
    <span class="directive">final</span> ToDoItem.CompletedEvent<span class="type">[]</span> evHolder = <span class="keyword">new</span> ToDoItem.CompletedEvent[<span class="integer">1</span>];    <i class="conum" data-value="2"></i><b>(2)</b>
    eventBusService.register(<span class="keyword">new</span> <span class="predefined-type">Object</span>() {
        <span class="annotation">@Subscribe</span>
        <span class="directive">public</span> <span class="type">void</span> on(<span class="directive">final</span> ToDoItem.CompletedEvent ev) {                        <i class="conum" data-value="3"></i><b>(3)</b>
            evHolder[<span class="integer">0</span>] = ev;
        }
    });

    <span class="comment">// when</span>
    toDoItem.completed();                                                         <i class="conum" data-value="4"></i><b>(4)</b>

    <span class="comment">// then</span>
    then(evHolder[<span class="integer">0</span>].getSource()).isEqualTo(unwrap(toDoItem));                    <i class="conum" data-value="5"></i><b>(5)</b>
    then(evHolder[<span class="integer">0</span>].getIdentifier().getMemberName()).isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">completed</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>inject <a href="rgsvc.html#_rgsvc_api_EventBusService"><code>EventBusService</code></a> into this test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>holder for subscriber to capture event to</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>subscriber&#8217;s callback, using the guava subscriber syntax</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>invoking the domain object using the wrapper</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>assert that the event was populated</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The wrapper will also fire domain events for properties (if annotated with <code>@Property(domainEvent=&#8230;&#8203;)</code>) or collections (if annotated with <code>@Collection(domainEvent=&#8230;&#8203;)</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It isn&#8217;t possible to use the <code>WrapperFactory</code> in a unit test, because there needs to be a running instance of Apache Isis that holds the metamodel.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ugtst_integ-test-support_maven-configuration">4.4. Maven Configuration</h3>
<div class="paragraph">
<p>Apache Isis' integration test support is automatically configured if you use the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a>.  To set it up manually, update the <code>pom.xml</code> of your domain object model module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.isis.core<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>isis-core-integtestsupport<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.isis.core<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>isis-core-wrapper<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also recommend that you configure the <code>maven-surefire-plugin</code> to pick up the following class patterns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.10<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;configuration&gt;</span>
        <span class="tag">&lt;includes&gt;</span>
            <span class="tag">&lt;include&gt;</span>**/*Test.java<span class="tag">&lt;/include&gt;</span>
            <span class="tag">&lt;include&gt;</span>**/*Test_*.java<span class="tag">&lt;/include&gt;</span>
            <span class="tag">&lt;include&gt;</span>**/*Spec*.java<span class="tag">&lt;/include&gt;</span>
        <span class="tag">&lt;/includes&gt;</span>
        <span class="tag">&lt;excludes&gt;</span>
            <span class="tag">&lt;exclude&gt;</span>**/Test*.java<span class="tag">&lt;/exclude&gt;</span>
            <span class="tag">&lt;exclude&gt;</span>**/*ForTesting.java<span class="tag">&lt;/exclude&gt;</span>
            <span class="tag">&lt;exclude&gt;</span>**/*Abstract*.java<span class="tag">&lt;/exclude&gt;</span>
        <span class="tag">&lt;/excludes&gt;</span>
        <span class="tag">&lt;useFile&gt;</span>true<span class="tag">&lt;/useFile&gt;</span>
        <span class="tag">&lt;printSummary&gt;</span>true<span class="tag">&lt;/printSummary&gt;</span>
        <span class="tag">&lt;outputDirectory&gt;</span>${project.build.directory}/surefire-reports<span class="tag">&lt;/outputDirectory&gt;</span>
    <span class="tag">&lt;/configuration&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ugtst_bdd-spec-support">5. BDD Spec Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://en.wikipedia.org/wiki/Behavior-driven_development">Behaviour-driven design</a> (BDD) redefines testing not as an after-the-fact "let&#8217;s check the system works", but rather as a means to work with the domain expert to (a) specify the behaviour of the feature <em>before</em> starting implementation, and (b) provide a means that the domain expert can verify the feature after it has been implemented.</p>
</div>
<div class="paragraph">
<p>Since domain experts are usually non-technical (at least, they are unlikely to be able to read or want to learn how to read JUnit/Java code), then applying BDD typically requires writing specifications in using structured English text and (ASCII) tables.  The BDD tooling parses this text and uses it to actually interact with the system under test.  As a byproduct the BDD frameworks generate readable output of some form; this is often an annotated version of the original specification, marked up to indicate which specifications passed, which have failed.  This readable output is a form of "living documentation"; it captures the actual behaviour of the system, and so is guaranteed to be accurate.</p>
</div>
<div class="paragraph">
<p>There are many BDD tools out there; Apache Isis provides an integration with <a href="https://cucumber.io/docs/reference/jvm#java">Cucumber JVM</a> (see also the <a href="https://github.com/cucumber/cucumber-jvm">github site</a>):</p>
</div>
<div class="sect2">
<h3 id="_ugtst_bdd-spec-support_how-it-works">5.1. How it works</h3>
<div class="paragraph">
<p>At a high level, here&#8217;s how Cucumber works</p>
</div>
<div class="ulist">
<ul>
<li>
<p>specifications are written in the <a href="https://github.com/cucumber/cucumber/wiki/Gherkin">Gherkin</a> DSL, following the <a href="https://github.com/cucumber/cucumber/wiki/Given-When-Then">"given/when/then"</a> format.</p>
</li>
<li>
<p>Cucumber-JVM itself is a JUnit runner, and searches for <a href="https://github.com/cucumber/cucumber/wiki/Feature-Introduction">feature files</a> on the classpath.</p>
</li>
<li>
<p>These in turn are matched to <a href="https://github.com/cucumber/cucumber/wiki/Step-Definitions">step definition</a>s through regular expressions.<br></p>
<div class="paragraph">
<p>It is the step definitions (the "glue") that exercise the system.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The code that goes in step definitions is broadly the same as the code that goes in an integration test method.  One benefit of using step definitions (rather than integration tests) is that the step definitions are reusable across scenarios, so there may be less code overall to maintain.  For example, if you have a step definition that maps to "given an uncompleted todo item", then this can be used for all the scenarios that start with that as their precondition.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ugtst_bdd-spec-support_key-classes">5.2. Key classes</h3>
<div class="paragraph">
<p>There are some key framework classes that make up the spec support; these are discussed below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
some of these are also used by Apache Isis' <a href="#_ugtst_integ-test-support">Integration Test support</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="__code_isissystemfortest_code">5.2.1. <code>IsisSystemForTest</code></h4>
<div class="paragraph">
<p>The <code>IsisSystemForTest</code> class allows a complete running instance of Apache Isis to be bootstrapped (with the JDO objectstore); this is then held on a a <code>ThreadLocal</code> from one test to another.</p>
</div>
<div class="paragraph">
<p>Typically bootstrapping code is used to lazily instantiate the <code>IsisSystemForTest</code> once and once only. The mechanism for doing this is line-for-line identical in both BDD step defs and integration tests.</p>
</div>
</div>
<div class="sect3">
<h4 id="__code_scenarioexecution_code">5.2.2. <code>ScenarioExecution</code></h4>
<div class="paragraph">
<p>The <code>ScenarioExecution</code> provides a context for a scenario that is being executed.  It is Cucumber that determines which step definitions are run, and in which order, and so state cannot be passed between step definitions using local variables or instance variables.  Instead the <code>ScenarioExecution</code> acts like a hashmap, allowing each step to put data (eg "given an uncompleted todoitem") into the map or get data ("when I complete the todoitem") from the map.  This is done using the <code>putVar(&#8230;&#8203;)</code> and <code>getVar(&#8230;&#8203;)</code> methods.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This corresponds broadly to the "World" object in Ruby-flavoured Cucumber.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>ScenarioExecution</code> also provids access to the configured domain services (using the <code>service(&#8230;&#8203;)</code> method) and the <code>DomainObjectContainer</code> (through the <code>container()</code> method).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This could probably be refactored; Cucumber JVM provides automatic dependency injection into setp definitions, but Apache Isis does not currently leverage or exploit this capability.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Like the <code>IsisSystemForTest</code> class, the <code>ScenarioExecution</code> class binds an instance of itself onto a <code>ThreadLocal</code>. It can then be accessed in BDD step definitions using <code>ScenarioExecution.current()</code> static method.</p>
</div>
</div>
<div class="sect3">
<h4 id="__code_wrapperfactory_code">5.2.3. <code>WrapperFactory</code></h4>
<div class="paragraph">
<p>As with integration tests, the UI can be simulated by "wrapping" each domain object in a proxy using the <code>WrapperFactory</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__code_cukeglueabstract_code">5.2.4. <code>CukeGlueAbstract</code></h4>
<div class="paragraph">
<p>The <code>CukeGlueAbstract</code> acts as a convenience superclass for writing BDD step definitions (analogous to the <code>IntegrationTestAbstract</code> for integation tests).  Underneath the covers it delegates to an underlying <code>ScenarioExecution</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ugtst_bdd-spec-support_writing-a-bdd-spec">5.3. Writing a BDD spec</h3>
<div class="paragraph">
<p>BDD specifications contain:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <code>XxxSpec.feature</code> file, describing the feature and the scenarios (given/when/then)s that constitute its acceptance criteria</p>
</li>
<li>
<p>a <code>RunSpecs.java</code> class file to run the specification (all boilerplate). This will run all <code>.feature</code> files in the same package or subpackages.</p>
</li>
<li>
<p>one or several <code>XxxGlue</code> constituting the step definitions to be matched against.<br></p>
<div class="paragraph">
<p>The "glue" (step definitions) are intended to be reused across features. We therefore recommend that they reside in a separate package, and are organized by the entity type upon which they act.<br></p>
</div>
<div class="paragraph">
<p>For example, given a feature that involves <code>Customer</code> and <code>Order</code>, have the step definitions pertaining to <code>Customer</code> reside in <code>CustomerGlue</code>, and the step definitions pertaining to <code>Order</code> reside in <code>OrderGlue</code>.<br></p>
</div>
<div class="paragraph">
<p>The <code>glue</code> attribute of the Cucumber-JVM JUnit runner eallows you to indicate which package(s) should be recursively searched to find any glue.</p>
</div>
</li>
<li>
<p>a system initializer class.  You can reuse the  system initializer from any integration tests (as described in <a href="#_ugtst_integ-test-support">Integration Test Support</a>, bootstrapping section).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of a feature from the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SimpleObjectsFixture</span>
Feature: <span class="predefined-type">List</span> and Create New Simple Objects

  <span class="annotation">@integration</span>
  Scenario: Existing simple objects can be listed and <span class="keyword">new</span> ones created
    Given there are initially <span class="integer">3</span> simple objects
    When  I create a <span class="keyword">new</span> simple object
    Then  there are <span class="integer">4</span> simple objects</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@SimpleObjectsFixture</code> is a custom tag we&#8217;ve specified to indicate the prerequisite fixtures to be loaded; more on this in a moment. The <code>@integration</code> tag, meanwhile, says that this feature should be run with integration-level scope.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Although BDD specs are most commonly used for end-to-end tests (ie at the same scope as an integration test), the two concerns (expressability of a test to a business person vs granularity of the test) should not be conflated. There are a couple of <a href="http://silkandspinach.net/2013/01/18/a-testing-strategy/">good</a> blog <a href="http://claysnow.co.uk/the-testing-iceberg/">posts</a> discussing <a href="http://claysnow.co.uk/living-documentation-can-be-readable-and-fast/">this</a>. The basic idea is to avoid the overhead of a heavy-duty integration test if possible.</p>
</div>
<div class="paragraph">
<p>Apache Isis does also support running BDD specs in unit test mode; by annotating the scenario with the <code>@unit</code> (rather than <code>@integration</code> tag).  When running under unit-level scope, the Apache Isis system is <em>not</em> instantiated.  Instead, the <code>ScenarioExecution</code> class returns JMock mocks (except for the <code>WrapperFactory</code>, if configured).</p>
</div>
<div class="paragraph">
<p>To support unit testing scope Apache Isis provides the <code>InMemoryDB</code> class; a glorified hashmap of "persisted" objects.  Use of this utility class is optional.</p>
</div>
<div class="paragraph">
<p>Writing a BDD spec that supports both modes of operation therefore takes more effort and we expect most users interested in BDD will use integration-testing scope; for these reasons we have chosen <em>not</em> to include unit-testing support in the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a>.  For those who do require faster-executing test suite, it&#8217;s worthwhile knowing that Apache Isis can support this.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>RunSpecs</code> class to run this feature (and any other features in this package or subpackages) is just boilerplate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RunWith</span>(Cucumber.class)
<span class="annotation">@CucumberOptions</span>(
        format = {
                <span class="string"><span class="delimiter">&quot;</span><span class="content">html:target/cucumber-html-report</span><span class="delimiter">&quot;</span></span>
                ,<span class="string"><span class="delimiter">&quot;</span><span class="content">json:target/cucumber.json</span><span class="delimiter">&quot;</span></span>
        },
        glue={<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:domainapp.integtests.specglue</span><span class="delimiter">&quot;</span></span>},
        strict = <span class="predefined-constant">true</span>,
        tags = { <span class="string"><span class="delimiter">&quot;</span><span class="content">~@backlog</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">~@ignore</span><span class="delimiter">&quot;</span></span> })
<span class="directive">public</span> <span class="type">class</span> <span class="class">RunSpecs</span> {
    <span class="comment">// intentionally empty</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JSON formatter allows integration with enhanced reports, for example as provided by <a href="http://www.masterthought.net/section/cucumber-reporting">Masterthought.net</a> (screenshots at end of page). (Commented out) configuration for this is provided in the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a>.</p>
</div>
<div class="paragraph">
<p>The bootstrapping of Apache Isis can be moved into a <code>BootstrappingGlue</code> step definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BootstrappingGlue</span> <span class="directive">extends</span> CukeGlueAbstract {
    <span class="annotation">@Before</span>(value={<span class="string"><span class="delimiter">&quot;</span><span class="content">@integration</span><span class="delimiter">&quot;</span></span>}, order=<span class="integer">100</span>)
    <span class="directive">public</span> <span class="type">void</span> beforeScenarioIntegrationScope() {
        org.apache.log4j.PropertyConfigurator.configure(<span class="string"><span class="delimiter">&quot;</span><span class="content">logging.properties</span><span class="delimiter">&quot;</span></span>);
        SimpleAppSystemInitializer.initIsft();

        before(ScenarioExecutionScope.INTEGRATION);
    }
    <span class="annotation">@After</span>
    <span class="directive">public</span> <span class="type">void</span> afterScenario(cucumber.api.Scenario sc) {
        assertMocksSatisfied();
        after(sc);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The fixture to run also lives in its own step definition, <a href="https://github.com/apache/isis/blob/07fe61ef3fb029ae36427f60da2afeeb931e4f88/example/application/simpleapp/integtests/src/test/java/domainapp/integtests/specglue/CatalogOfFixturesGlue.java#L24"><code>CatalogOfFixturesGlue</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CatalogOfFixturesGlue</span> <span class="directive">extends</span> CukeGlueAbstract {
    <span class="annotation">@Before</span>(value={<span class="string"><span class="delimiter">&quot;</span><span class="content">@integration</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">@SimpleObjectsFixture</span><span class="delimiter">&quot;</span></span>}, order=<span class="integer">20000</span>)
    <span class="directive">public</span> <span class="type">void</span> integrationFixtures() <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
        scenarioExecution().install(<span class="keyword">new</span> RecreateSimpleObjects());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this is annotated with a tag (<code>@SimpleObjectsFixture</code>) so that the correct fixture runs. (We might have a whole variety of these).</p>
</div>
<div class="paragraph">
<p>The step definitions pertaining to <code>SimpleObject</code> domain entity then reside in the <a href="https://github.com/apache/isis/blob/07fe61ef3fb029ae36427f60da2afeeb931e4f88/example/application/simpleapp/integtests/src/test/java/domainapp/integtests/specglue/modules/simple/SimpleObjectGlue.java#L31"><code>SimpleObjectGlue</code></a> class. This is where the heavy lifting gets done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleObjectGlue</span> <span class="directive">extends</span> CukeGlueAbstract {
    <span class="annotation">@Given</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">^there are.* (</span><span class="char">\\</span><span class="content">d+) simple objects$</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> there_are_N_simple_objects(<span class="type">int</span> n) <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
        <span class="keyword">try</span> {
            <span class="directive">final</span> <span class="predefined-type">List</span>&lt;SimpleObject&gt; findAll = service(SimpleObjects.class).listAll();
            assertThat(findAll.size(), is(n));
            putVar(<span class="string"><span class="delimiter">&quot;</span><span class="content">list</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">all</span><span class="delimiter">&quot;</span></span>, findAll);

        } <span class="keyword">finally</span> {
            assertMocksSatisfied();
        }
    }
    <span class="annotation">@When</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">^I create a new simple object$</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> I_create_a_new_simple_object() <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
        service(SimpleObjects.class).create(<span class="predefined-type">UUID</span>.randomUUID().toString());
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If using Java 8, note that Cucumber JVM supports a <a href="https://cucumber.io/docs/reference/jvm#java-8-lambdas">simplified syntax using lambdas</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_ugtst_bdd-spec-support_bdd-tooling">5.4. BDD Tooling</h3>
<div class="paragraph">
<p>To help write feature files and generate step definitions, we recommend <a href="https://github.com/rlogiacco/Natural">Roberto Lo Giacco&#8217;s Eclipse plugin</a>. For more information, see Dan&#8217;s short <a href="http://danhaywood.com/2013/07/05/cucumber-editors-in-eclipse/">blog post</a>. It works very well. Of interest: this is implemented using <a href="http://www.eclipse.org/Xtext/">XText</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ugtst_bdd-spec-support_maven-configuration">5.5. Maven Configuration</h3>
<div class="paragraph">
<p>Apache Isis' BDD spec support is automatically configured if you use the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a>.  To set it up manually, update the <code>pom.xml</code> of your domain object model module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.isis.core<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>isis-core-specsupport<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Normally <code>test</code>; usual Maven scoping rules apply.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We also recommend that you configure the <code>maven-surefire-plugin</code> to pick up the following class patterns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.10<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;configuration&gt;</span>
        <span class="tag">&lt;includes&gt;</span>
            <span class="tag">&lt;include&gt;</span>**/*Test.java<span class="tag">&lt;/include&gt;</span>
            <span class="tag">&lt;include&gt;</span>**/*Test_*.java<span class="tag">&lt;/include&gt;</span>
            <span class="tag">&lt;include&gt;</span>**/*Spec*.java<span class="tag">&lt;/include&gt;</span>
        <span class="tag">&lt;/includes&gt;</span>
        <span class="tag">&lt;excludes&gt;</span>
            <span class="tag">&lt;exclude&gt;</span>**/Test*.java<span class="tag">&lt;/exclude&gt;</span>
            <span class="tag">&lt;exclude&gt;</span>**/*ForTesting.java<span class="tag">&lt;/exclude&gt;</span>
            <span class="tag">&lt;exclude&gt;</span>**/*Abstract*.java<span class="tag">&lt;/exclude&gt;</span>
        <span class="tag">&lt;/excludes&gt;</span>
        <span class="tag">&lt;useFile&gt;</span>true<span class="tag">&lt;/useFile&gt;</span>
        <span class="tag">&lt;printSummary&gt;</span>true<span class="tag">&lt;/printSummary&gt;</span>
        <span class="tag">&lt;outputDirectory&gt;</span>${project.build.directory}/surefire-reports<span class="tag">&lt;/outputDirectory&gt;</span>
    <span class="tag">&lt;/configuration&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You may also find it more convenient to place the <code>.feature</code> files in <code>src/test/java</code>, rather than <code>src/test/resources</code>.  If you wish to do this, then your integtest module&#8217;s <code>pom.xml</code> must contain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;build&gt;</span>
    <span class="tag">&lt;testResources&gt;</span>
        <span class="tag">&lt;testResource&gt;</span>
            <span class="tag">&lt;filtering&gt;</span>false<span class="tag">&lt;/filtering&gt;</span>
            <span class="tag">&lt;directory&gt;</span>src/test/resources<span class="tag">&lt;/directory&gt;</span>
        <span class="tag">&lt;/testResource&gt;</span>
        <span class="tag">&lt;testResource&gt;</span>
            <span class="tag">&lt;filtering&gt;</span>false<span class="tag">&lt;/filtering&gt;</span>
            <span class="tag">&lt;directory&gt;</span>src/test/java<span class="tag">&lt;/directory&gt;</span>
            <span class="tag">&lt;includes&gt;</span>
                <span class="tag">&lt;include&gt;</span>**<span class="tag">&lt;/include&gt;</span>
            <span class="tag">&lt;/includes&gt;</span>
            <span class="tag">&lt;excludes&gt;</span>
                <span class="tag">&lt;exclude&gt;</span>**/*.java<span class="tag">&lt;/exclude&gt;</span>
            <span class="tag">&lt;/excludes&gt;</span>
        <span class="tag">&lt;/testResource&gt;</span>
    <span class="tag">&lt;/testResources&gt;</span>
<span class="tag">&lt;/build&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ugtst_fixture-scripts">6. Fixture Scripts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When writing integration tests (and implementing the glue for BDD specs) it can be difficult to keep the "given" short; there could be a lot of prerequisite data that needs to exist before you can actually exercise your system.  Moreover, however we do set up that data, but we also want to do so in a way that is resilient to the system changing over time.</p>
</div>
<div class="paragraph">
<p>On a very simple system you could probably get away with using SQL to insert directly into the database, or you could use a toolkit such as <a href="http://dbunit.sourceforge.net/howto.html">dbunit</a> to upload data from flat files.  Such approaches aren&#8217;t particularly maintainable though.  If in the future the domain entities (and therefore corresponding database tables) change their structure, then all of those data sets will need updating.</p>
</div>
<div class="paragraph">
<p>Even more significantly, there&#8217;s no way to guarantee that the data that&#8217;s being loaded is logically consistent with the business behaviour of the domain objects themselves.  That is, there&#8217;s nothing to stop your test from putting data into the database that would be invalid if one attempted to add it through the app.</p>
</div>
<div class="paragraph">
<p>The solution that Apache Isis provides is a small library called <strong><em>fixture scripts</em></strong>.  A fixture script is basically a wrapper for executing arbitrary work, but that work almost always invoking a business action.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you want to learn more on this topic (with live coding!), check out this <a href="https://skillsmatter.com/skillscasts/5638-to-those-whom-much-is-given-much-is-expected">presentation</a> given at BDD Exchange 2014.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is another benefit to Apache Isis' fixture script approach; the fixtures can be (in prototyping mode) run from your application.  This means that fixture scripts can actually help all the way through the development lifecycle:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when specifying a new feature, you can write a fixture script to get the system into the "given" state, and then start exploring the required functionality with the domain expert actually <em>within</em> the application<br></p>
<div class="paragraph">
<p>And if you can&#8217;t write a fixture script for the story, it probably means that there&#8217;s some prerequisite feature that needs implementing that you hadn&#8217;t previously recognized</p>
</div>
</li>
<li>
<p>when the developer implements the story, s/he has a precanned script to run when they manually verify the functionality works</p>
</li>
<li>
<p>when the developer automates the story&#8217;s acceptance test as an integration test, they already have the "given" part of the test implemented</p>
</li>
<li>
<p>when you want to pass the feature over to the QA/tester for additional manual exploratory testing, they have a fixture script to get them to a jumping off point for their explorations</p>
</li>
<li>
<p>when you want to demonstrate the implemented feature to your domain expert, your demo can use the fixture script so you don&#8217;t bore your audience in performing lots of boring setup before getting to the actual feature</p>
</li>
<li>
<p>when you want to roll out training to your users, you can write fixture scripts as part of their training exercises</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following  sections explain the API and how to go about using the API.</p>
</div>
<div class="sect2">
<h3 id="_ugtst_fixture-scripts_api-and-usage">6.1. API and Usage</h3>
<div class="paragraph">
<p>There are two parts to using fixture scripts: the <code>FixtureScripts</code> domain service class, and the <code>FixtureScript</code> view model class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The role of the <code>FixtureScripts</code> domain service is to locate all fixture scripts from the classpath and to let them be invoked, either from an integration test/BDD spec or from the UI of your Isis app.</p>
</li>
<li>
<p>The role of <code>FixtureScript</code> meanwhile is to subclass for each of the scenarios that you want to define.  You can also subclass from <code>FixtureScript</code> to create helpers; more on this below.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s look at <code>FixtureScripts</code> domain service in more detail first.</p>
</div>
<div class="sect3">
<h4 id="__code_fixturescripts_code">6.1.1. <code>FixtureScripts</code></h4>
<div class="paragraph">
<p>There are two ways in which you can provide a <code>FixtureScripts</code> service.</p>
</div>
<div class="paragraph">
<p>The original (pre-1.9.0) approach is to subclass subclass <code>FixtureScripts</code> domain service, with your subclass specifying which package to search for.  Various other settings can also be provided, and - being a custom class - you can also add in additional actions.  A common example is to provide a "one-shot" action to recreate a standard demo set of objects.</p>
</div>
<div class="paragraph">
<p>As of 1.9.0 there is an alternative design.  Instead of subclassing <code>FixtureScripts</code> you instead implement the <a href="rgsvc.html#_rgsvc_spi_FixtureScriptsSpecificationProvider"><code>FixtureScriptsSpecificationProvider</code></a> SPI.  (As its name suggests), this provides a <code>FixtureScriptsSpecification</code> object that contains the same information as would otherwise have been in the <code>FixtureScripts</code> subclass.</p>
</div>
<div class="paragraph">
<p>The actual implementation of the <code>FixtureScripts</code> service is then provided by the framework itself, namely the <a href="rgsvc.html#_rgsvc_api_FixtureScriptsDefault"><code>FixtureScriptsDefault</code></a> domain service, annotated to be rendered on the secondary "Prototyping" menu.  This uses the <code>FixtureScriptsSpecificationProvider</code> to adjust itself accordinly.</p>
</div>
<div class="paragraph">
<p>For example, here&#8217;s the <code>FixtureScriptsSpecificationProvider</code> service that&#8217;s generated by the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@DomainService</span>(nature = NatureOfService.DOMAIN)
<span class="directive">public</span> <span class="type">class</span> <span class="class">DomainAppFixturesProvider</span> <span class="directive">implements</span> FixtureScriptsSpecificationProvider {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> FixtureScriptsSpecification getSpecification() {
        <span class="keyword">return</span> FixtureScriptsSpecification
                .builder(DomainAppFixturesProvider.class)                                       <i class="conum" data-value="1"></i><b>(1)</b>
                .with(FixtureScripts.MultipleExecutionStrategy.EXECUTE)                         <i class="conum" data-value="2"></i><b>(2)</b>
                .withRunScriptDefault(RecreateSimpleObjects.class)                              <i class="conum" data-value="3"></i><b>(3)</b>
                .withRunScriptDropDown(FixtureScriptsSpecification.DropDownPolicy.CHOICES)      <i class="conum" data-value="4"></i><b>(4)</b>
                .withRecreate(RecreateSimpleObjects.class)                                      <i class="conum" data-value="5"></i><b>(5)</b>
                .build();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>search for all fixture scripts under the package containing this class</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>if the same fixture script (class) is encountered more than once, then run anyway; more on this in <a href="#_ugtst_fixture-scripts_api-and-usage_organizing">Organizing Fixture scripts</a>], below.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>specify the fixture script class to provide as the default for the service&#8217;s "run fixture script" action</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>whether the service&#8217;s "run fixture script" action should display other fixture scripts using a choices drop down or (if there are very many of them) using an auto-complete</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>if present, enables a "recreate objects and return first" action to be displayed in the UI</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The benefit of this design - decoupling the responsibilities of the superclass and the subclass - is that it ensures that there is always an instance of <code>FixtureScripts</code> available, even if the application itself doesn&#8217;t provide one.  Some of the (non-ASF) <a href="http://isisaddons.org">Isis Addons</a> modules (eg <a href="http://github.com/isisaddons/isis-module-security">Isis addons' security</a> module) expect there to be a <code>FixtureScripts</code> service for seeding data, which has caused some confusion.</p>
</div>
<div class="paragraph">
<p>By way of comparison, if using the older pre-1.9.0 approach then you would create a subclass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@DomainService</span>
<span class="annotation">@DomainServiceLayout</span>(
        menuBar = DomainServiceLayout.MenuBar.SECONDARY,           <i class="conum" data-value="1"></i><b>(1)</b>
        named=<span class="string"><span class="delimiter">&quot;</span><span class="content">Prototyping</span><span class="delimiter">&quot;</span></span>,                                       <i class="conum" data-value="2"></i><b>(2)</b>
        menuOrder = <span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span>
)
<span class="directive">public</span> <span class="type">class</span> <span class="class">DomainAppFixturesService</span> <span class="directive">extends</span> FixtureScripts {     <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">public</span> DomainAppFixturesService() {
        <span class="local-variable">super</span>(
            <span class="string"><span class="delimiter">&quot;</span><span class="content">domainapp</span><span class="delimiter">&quot;</span></span>,                                           <i class="conum" data-value="4"></i><b>(4)</b>
            MultipleExecutionStrategy.EXECUTE);                    <i class="conum" data-value="5"></i><b>(5)</b>
    }
    <span class="annotation">@Override</span>
    <span class="directive">public</span> FixtureScript default0RunFixtureScript() {
        <span class="keyword">return</span> findFixtureScriptFor(RecreateSimpleObjects.class);  <i class="conum" data-value="6"></i><b>(6)</b>
    }
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;FixtureScript&gt; choices0RunFixtureScript() {        <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="keyword">return</span> <span class="local-variable">super</span>.choices0RunFixtureScript();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>in the UI, render the on the right hand side (secondary) menu bar&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>&#8230;&#8203; under the "Prototyping" menu</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>inherit from <code>org.apache.isis.applib.fixturescripts.FixtureScripts</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>search for all fixture scripts under the "domainapp" package; in your code this would probably be "com.mycompany.myapp" or similar</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>if the same fixture script (class) is encountered more than once, then run anyway; more on this in <a href="#_ugtst_fixture-scripts_api-and-usage_organizing">Organizing Fixture scripts</a>], below.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>(optional) specify a default fixture script to run, in this case <code>RecreateSimpleObjects</code> fixture script (see below)</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>make all fixture scripts found available as a drop-down (by increasing the visibility of this method to <code>public</code>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This isn&#8217;t quite equivalent; you would need to write additional code to support the "recreate objects and return first" action, for example.</p>
</div>
<div class="paragraph">
<p>Either way, here&#8217;s how the domain service looks like in the UI:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="images/testing/fixture-scripts/prototyping-menu.png"><img src="images/testing/fixture-scripts/prototyping-menu.png" alt="prototyping menu" width="700px"></a>
</div>
</div>
<div class="paragraph">
<p>and here&#8217;s what the <code>runFixtureScript</code> action prompt looks like:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="images/testing/fixture-scripts/prompt.png"><img src="images/testing/fixture-scripts/prompt.png" alt="prompt" width="700px"></a>
</div>
</div>
<div class="paragraph">
<p>when this is executed, the resultant objects (actually, instances of FixtureResult`) are shown in the UI:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="images/testing/fixture-scripts/result-list.png"><img src="images/testing/fixture-scripts/result-list.png" alt="result list" width="700px"></a>
</div>
</div>
<div class="paragraph">
<p>If you had defined many fixture scripts then a drop-down might become unwieldy, in which case your code would probably override the <code>autoComplete&#8230;&#8203;())</code> instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;FixtureScript&gt; autoComplete0RunFixtureScript(<span class="directive">final</span> <span class="annotation">@MinLength</span>(<span class="integer">1</span>) <span class="predefined-type">String</span> searchArg) {
        <span class="keyword">return</span> <span class="local-variable">super</span>.autoComplete0RunFixtureScript(searchArg);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>You are free, of course, to add additional "convenience" actions into it if you wish for the most commonly used/demo&#8217;d setups ; you&#8217;ll find that the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a> adds this additional action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Action</span>(
            restrictTo = RestrictTo.PROTOTYPING
    )
    <span class="annotation">@ActionLayout</span>(
            cssClassFa=<span class="string"><span class="delimiter">&quot;</span><span class="content">fa fa-refresh</span><span class="delimiter">&quot;</span></span>
    )
    <span class="annotation">@MemberOrder</span>(sequence=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">Object</span> recreateObjectsAndReturnFirst() {
        <span class="directive">final</span> <span class="predefined-type">List</span>&lt;FixtureResult&gt; run = findFixtureScriptFor(RecreateSimpleObjects.class).run(<span class="predefined-constant">null</span>);
        <span class="keyword">return</span> run.get(<span class="integer">0</span>).getObject();
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now look at the <code>FixtureScript</code> class, where there&#8217;s a bit more going on.</p>
</div>
</div>
<div class="sect3">
<h4 id="__code_fixturescript_code">6.1.2. <code>FixtureScript</code></h4>
<div class="paragraph">
<p>A fixture script is ultimately just a block of code that can be executed, so it&#8217;s up to you how you implement it to set up the system.  However, we strongly recommend that you use it to invoke actions on business objects, in essence to replay what a real-life user would have done.  That way, the fixture script will remain valid even if the underlying implementation of the system changes in the future.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the <code>RecreateSimpleObjects</code> fixture script from the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RecreateSimpleObjects</span> <span class="directive">extends</span> FixtureScript {                   <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; NAMES = <span class="predefined-type">Collections</span>.unmodifiableList(<span class="predefined-type">Arrays</span>.asList(
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bar</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Baz</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Frodo</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Froyo</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Fizz</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bip</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bop</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bang</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Boo</span><span class="delimiter">&quot;</span></span>));                           <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">public</span> RecreateSimpleObjects() {
        withDiscoverability(Discoverability.DISCOVERABLE);                   <i class="conum" data-value="3"></i><b>(3)</b>
    }
    <span class="directive">private</span> <span class="predefined-type">Integer</span> number;                                                  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="directive">public</span> <span class="predefined-type">Integer</span> getNumber() { <span class="keyword">return</span> number; }
    <span class="directive">public</span> RecreateSimpleObjects setNumber(<span class="directive">final</span> <span class="predefined-type">Integer</span> number) {
        <span class="local-variable">this</span>.number = number;
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">List</span>&lt;SimpleObject&gt; simpleObjects = Lists.newArrayList();   <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;SimpleObject&gt; getSimpleObjects() {
        <span class="keyword">return</span> simpleObjects;
    }
    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="type">void</span> execute(<span class="directive">final</span> ExecutionContext ec) {          <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="comment">// defaults</span>
        <span class="directive">final</span> <span class="type">int</span> number = defaultParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">number</span><span class="delimiter">&quot;</span></span>, ec, <span class="integer">3</span>);        <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="comment">// validate</span>
        <span class="keyword">if</span>(number &lt; <span class="integer">0</span> || number &gt; NAMES.size()) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(
                <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">number must be in range [0,%d)</span><span class="delimiter">&quot;</span></span>, NAMES.size()));
        }
        <span class="comment">// execute</span>
        ec.executeChild(<span class="local-variable">this</span>, <span class="keyword">new</span> SimpleObjectsTearDown());      <i class="conum" data-value="8"></i><b>(8)</b>
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; number; i++) {
            <span class="directive">final</span> SimpleObjectCreate fs =
                <span class="keyword">new</span> SimpleObjectCreate().setName(NAMES.get(i));
            ec.executeChild(<span class="local-variable">this</span>, fs.getName(), fs);             <i class="conum" data-value="9"></i><b>(9)</b>
            simpleObjects.add(fs.getSimpleObject());             <i class="conum" data-value="10"></i><b>(10)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>inherit from <code>org.apache.isis.applib.fixturescripts.FixtureScript</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>a hard-coded list of values for the names.  Note that the <a href="http://github.com/isisaddons/isis-module-fakedata">Isis addons' fakedata</a> module (non-ASF) could also have been used</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>whether the script is "discoverable"; in other words whether it should be rendered in the drop-down by the <code>FixtureScripts</code> service</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>input property: the number of objects to create, up to 10; for the calling test to specify, but note this is optional and has a default (see below).  It&#8217;s important that a wrapper class is used (ie <code>java.lang.Integer</code>, not <code>int</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>output property: the generated list of objects, for the calling test to grab</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>the mandatory execute(&#8230;&#8203;) API</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>the <code>defaultParam(&#8230;&#8203;)</code> (inherited from <code>FixtureScript</code>) will default the <code>number</code> property (using Java&#8217;s Reflection API) if none was specified</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>call another fixture script (<code>SimpleObjectsTearDown</code>) using the provided <code>ExecutionContext</code>.  Note that although the fixture script is a view model, it&#8217;s fine to simply instantiate it (rather than using <code>DomainObjectContainer#newTransientInstance(&#8230;&#8203;)</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>calling another fixture script (<code>SimpleObjectCreate</code>) using the provided <code>ExecutionContext</code></td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>adding the created object to the list, for the calling object to use.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Because this script has exposed a "number" property, it&#8217;s possible to set this from within the UI.  For example:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/testing/fixture-scripts/prompt.png" alt="prompt" width="700px">
</div>
</div>
<div class="paragraph">
<p>When this is executed, the framework will parse the text and attempt to reflectively set the corresponding properties on the fixture result.  So, in this case, when the fixture script is executed we actually get 6 objects created:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/testing/fixture-scripts/result-list.png" alt="result list" width="700px">
</div>
</div>
<div class="paragraph">
<p>It&#8217;s commonplace for one fixture script to call another.  In the above example this script called <code>SimpleObjectsTearDown</code> and <code>SimpleObjectCreate</code>.  Let&#8217;s take a quick look at <code>SimpleObjectCreate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleObjectCreate</span> <span class="directive">extends</span> FixtureScript {       <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">private</span> <span class="predefined-type">String</span> name;                                      <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">public</span> <span class="predefined-type">String</span> getName() { <span class="keyword">return</span> name; }
    <span class="directive">public</span> SimpleObjectCreate setName(<span class="directive">final</span> <span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name;
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }
    <span class="directive">private</span> SimpleObject simpleObject;                        <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">public</span> SimpleObject getSimpleObject() {
        <span class="keyword">return</span> simpleObject;
    }
    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="type">void</span> execute(<span class="directive">final</span> ExecutionContext ec) {       <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="predefined-type">String</span> name = checkParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, ec, <span class="predefined-type">String</span>.class);   <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="local-variable">this</span>.simpleObject = wrap(simpleObjects)               <i class="conum" data-value="6"></i><b>(6)</b>
                                .create(name);                <i class="conum" data-value="7"></i><b>(7)</b>
        ec.addResult(<span class="local-variable">this</span>, simpleObject);                     <i class="conum" data-value="8"></i><b>(8)</b>
    }
    <span class="annotation">@javax</span>.inject.Inject
    <span class="directive">private</span> SimpleObjects simpleObjects;                      <i class="conum" data-value="9"></i><b>(9)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>inherit from <code>org.apache.isis.applib.fixturescripts.FixtureScript</code>, as above</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>input property: name of the object; this time it is required</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>output property: the created simple object</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>the mandatory execute(&#8230;&#8203;) API</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>the <code>checkParam(&#8230;&#8203;)</code> (inherited from <code>FixtureScript</code>) will check that the "name" property has been populated (using Java&#8217;s Reflection API) and throw an exception if not</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>wrap the injected <code>SimpleObjects</code> domain service (using the <a href="rgsvc.html#_rgsvc_api_WrapperFactory"><code>WrapperFactory</code></a>) to simulate interaction through the UI&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>.. and actually create the object using the "create" business action of that service</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>add the resulting object to the execution context; this makes the object available to access if run from the UI</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>inject the domain service into the fixture script</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_using_within_tests">6.1.3. Using within Tests</h4>
<div class="paragraph">
<p>Fixture scripts can be called from integration tests just the same way that fixture scripts can call one another.</p>
</div>
<div class="paragraph">
<p>For example, here&#8217;s an integration test from the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleObjectIntegTest</span> <span class="directive">extends</span> SimpleAppIntegTest {
    <span class="annotation">@Inject</span>
    FixtureScripts fixtureScripts;                      <i class="conum" data-value="1"></i><b>(1)</b>
    SimpleObject simpleObjectWrapped;
    <span class="annotation">@Before</span>
    <span class="directive">public</span> <span class="type">void</span> setUp() <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">// given</span>
        RecreateSimpleObjects fs =
             <span class="keyword">new</span> RecreateSimpleObjects().setNumber(<span class="integer">1</span>);  <i class="conum" data-value="2"></i><b>(2)</b>
        fixtureScripts.runFixtureScript(fs, <span class="predefined-constant">null</span>);      <i class="conum" data-value="3"></i><b>(3)</b>

        SimpleObject simpleObjectPojo =
            fs.getSimpleObjects().get(<span class="integer">0</span>);               <i class="conum" data-value="4"></i><b>(4)</b>
        assertThat(simpleObjectPojo).isNotNull();

        simpleObjectWrapped = wrap(simpleObjectPojo);   <i class="conum" data-value="5"></i><b>(5)</b>
    }
    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> accessible() <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">// when</span>
        <span class="directive">final</span> <span class="predefined-type">String</span> name = simpleObjectWrapped.getName();
        <span class="comment">// then</span>
        assertThat(name).isEqualTo(fs.NAMES.get(<span class="integer">0</span>));
    }
    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>inject the <code>FixtureScripts</code> domain service (just like any other domain service)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>instantiate the fixture script for this test, and configure</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>execute the fixture script</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>obtain the object under test from the fixture</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>wrap the object (to simulate being interacted with through the UI)</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_ugtst_fixture-scripts_api-and-usage_organizing">6.1.4. Organizing Fixture scripts</h4>
<div class="paragraph">
<p>There are lots of ways to organize fixture scripts, but we&#8217;ve used them as either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a fairly flat style, eg as in the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a>, also as in the <a href="http://github.com/isisaddons/isis-app-todoapp">Isis addons' todoapp</a>;</p>
</li>
<li>
<p>in a "composite pattern" style, eg as in the <a href="https://github.com/estatio/estatio/blob/ea20a6ce257acede50de6ce4fd2ff29713fcd689/estatioapp/fixture/src/main/java/org/estatio/fixture/invoice/InvoiceForLeaseItemTypeOfDiscountOneQuarterForOxfMiracle005.java#L66)">Estatio open source app</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These two styles are probably best illustrated with, well, some illustrations.  Here&#8217;s a fixture script in the "flat" style for setting up a customer with some orders, a number of which has been placed:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="images/testing/fixture-scripts/flat-1.png"><img src="images/testing/fixture-scripts/flat-1.png" alt="flat 1" width="700px"></a>
</div>
</div>
<div class="paragraph">
<p>Notice how we have a single script that&#8217;s in control of the overall process, and takes responsibility for passing data from one fixture script to the next.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a similar, simpler script, from the same fictional app, to set up two customers:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="images/testing/fixture-scripts/flat-2.png"><img src="images/testing/fixture-scripts/flat-2.png" alt="flat 2" width="500px"></a>
</div>
</div>
<div class="paragraph">
<p>We can reuse the same fixture "customer" script, either calling it twice or (perhaps better) passing it an array of customer details to set up.</p>
</div>
<div class="paragraph">
<p>With the composite style, we rely on each fixture script to set up its own prerequisites.  Thus:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="images/testing/fixture-scripts/composite.png"><img src="images/testing/fixture-scripts/composite.png" alt="composite" width="550px"></a>
</div>
</div>
<div class="paragraph">
<p>Back in the earlier section we noted the <code>MultipleExecutionStrategy</code> setting.  We can now explain the meaning of this: the enum value of <code>EXECUTE</code> is designed for the flat style (where every fixture script will be called), whereas the enum value of <code>IGNORE</code> is designed for the composite style, and ensures that any fixture scripts visited more than once (eg TearDown) are only every executed the first time.</p>
</div>
<div class="paragraph">
<p>As already noted , the app generated by the <a href="ugfun.html#_ugfun_getting-started_simpleapp-archetype">SimpleApp archetype</a> uses the flat structure, and we feel that it&#8217;s a better at separating out the "how" (how we set up some graph of domain objects into a known state, eg a customer with shipped placed orders and a newly placed order) from the "what" (what data should we actually use for the customer&#8217;s name, say).</p>
</div>
<div class="paragraph">
<p>The composite style tends to combine these, which one could argue does not separate responsibilities well enough.  On the other hand, one could also make an argument that the composite style is a good way to implement precanned personas, eg "Joe", the customer who has a newly placed order, from "Mary" customer who has none.</p>
</div>
<div class="sect4">
<h5 id="_further_approaches">Further approaches</h5>
<div class="paragraph">
<p>As of there are two other approaches.</p>
</div>
<div class="paragraph">
<p>The first is to take advantage of a new <code>MultipleExecutionStrategy</code>, namely <code>EXECUTE_ONCE_BY_VALUE</code>.  Under this strategy the determination as to whether to run a given fixture script is by comparing the fixture script against all others that have run.  If all fixture scripts implement value semantics, then they can effectively determine
whether they need to run or not.</p>
</div>
<div class="paragraph">
<p>This strategy was introduced in order to better support the <code>ExcelFixture</code> fixture script (provided by the
(non-ASF) <a href="http://github.com/isisaddons/isis-module-excel">Isis addons' excel</a> module.  The <code>ExcelFixture</code> takes an
Excel spreadsheet and loads up each row.  For those cases where we wish to ensure that the same spreadsheet is not
loaded more than once, the <code>IGNORE</code> strategy would have required that a trivial subclass of <code>ExcelFixture</code> is created
for each and every spreadsheet.  The <code>EXECUTE_ONCE_BY_VALUE</code> on the other hand delegates the determination to the
value semantics of the <code>ExcelFixture</code>, which is based on the contents of the spreadsheet.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that as of <code>1.10.0</code> the <code>IGNORE</code> enum has been deprecated, replaced by <code>EXECUTE_ONCE_BY_CLASS</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second approach is in recognition that there is, in fact, something of a design flaw with the concept of
<code>MultipleExecutionStrategy</code>: it requires that all fixture scripts being run follow the same conventions.  There&#8217;s a
good argument that this shouldn&#8217;t be a global "setting": the responsibility for determining whether a given fixture
script should be executed should reside not in the <code>FixtureScripts</code> service but in the <code>FixtureScript</code> itself.</p>
</div>
<div class="paragraph">
<p>Thus, the <code>FixtureScripts.ExecutionContext</code> exposes the <code>getPreviouslyExecuted()</code> method that allows the fixture
script to check for itself which fixture scripts have already been run, and act accordingly.  For this approach, the
<code>MultipleExecutionStrategy</code> should be left as simply <code>EXECUTE</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ugtst_fixture-scripts_sudo-service">6.2. <code>SudoService</code></h3>
<div class="paragraph">
<p>Sometimes in our fixture scripts we want to perform a business action running as a particular user.  This might be for the usual reason - so that our fixtures accurately reflect the reality of the system with all business constraints enforced using the <code>WrapperFactory</code> - or more straightforwardly it might be simply that the action depends on the identity of the user invoking the action.</p>
</div>
<div class="paragraph">
<p>An example of the latter case is in the (non-ASF) <a href="http://github.com/isisaddons/isis-app-todoapp">Isis addons' todoapp</a>'s <code>ToDoItem</code> class:</p>
</div>
<div class="listingblock">
<div class="title">Production code that depends on current user</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> ToDoItem newToDo(
        <span class="annotation">@Parameter</span>(regexPattern = <span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">w[@&amp;:</span><span class="char">\\</span><span class="content">-</span><span class="char">\\</span><span class="content">,</span><span class="char">\\</span><span class="content">.</span><span class="char">\\</span><span class="content">+ </span><span class="char">\\</span><span class="content">w]*</span><span class="delimiter">&quot;</span></span>) <span class="annotation">@ParameterLayout</span>(named=<span class="string"><span class="delimiter">&quot;</span><span class="content">Description</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">final</span> <span class="predefined-type">String</span> description,
        <span class="annotation">@ParameterLayout</span>(named=<span class="string"><span class="delimiter">&quot;</span><span class="content">Category</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">final</span> Category category,
        <span class="annotation">@Parameter</span>(optionality = Optionality.OPTIONAL) <span class="annotation">@ParameterLayout</span>(named=<span class="string"><span class="delimiter">&quot;</span><span class="content">Subcategory</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">final</span> Subcategory subcategory,
        <span class="annotation">@Parameter</span>(optionality = Optionality.OPTIONAL) <span class="annotation">@ParameterLayout</span>(named=<span class="string"><span class="delimiter">&quot;</span><span class="content">Due by</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">final</span> LocalDate dueBy,
        <span class="annotation">@Parameter</span>(optionality = Optionality.OPTIONAL) <span class="annotation">@ParameterLayout</span>(named=<span class="string"><span class="delimiter">&quot;</span><span class="content">Cost</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">final</span> <span class="predefined-type">BigDecimal</span> cost) {
    <span class="keyword">return</span> newToDo(description, category, subcategory, currentUserName(), dueBy, cost);
}
<span class="directive">private</span> <span class="predefined-type">String</span> currentUserName() {
    <span class="keyword">return</span> container.getUser().getName(); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>is the current user.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The fixture for this can use the <code>SudoService</code> to run a block of code as a specified user:</p>
</div>
<div class="listingblock">
<div class="title">Fixture Script</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> <span class="predefined-type">String</span> description = ...
final Category category = ...
final Subcategory subcategory = ...
final LocalDate dueBy = ...
final <span class="predefined-type">BigDecimal</span> cost = ...
final Location location = ...

toDoItem = sudoService.sudo(username,
        <span class="keyword">new</span> <span class="predefined-type">Callable</span>&lt;ToDoItem&gt;() {
            <span class="annotation">@Override</span>
            <span class="directive">public</span> ToDoItem call() {
                <span class="directive">final</span> ToDoItem toDoItem = wrap(toDoItems).newToDo(
                        description, category, subcategory, dueBy, cost);
                wrap(toDoItem).setLocation(location);
                <span class="keyword">return</span> toDoItem;
            }
        });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behind the scenes the <code>SudoService</code> simply talks to the <code>DomainObjectContainer</code> to override the user returned by the <code>getUser()</code> API.  It is possible to override both users and roles.</p>
</div>
</div>
</div>
</div>
        </div>

        <footer>
          <hr>
          <p class="small">
          Copyright &copy; 2010~2016 The Apache&nbsp;Software&nbsp;Foundation, licensed under the Apache&nbsp;License,&nbsp;v2.0.
          <br/>
          Apache, the Apache feather logo, Apache&nbsp;Isis, and the Apache&nbsp;Isis project logo are all trademarks of The&nbsp;Apache&nbsp;Software&nbsp;Foundation.
          </p>
        </footer>

    </div>

    <div id="doc-content-right" class="large-3 medium-3 xcolumns">
        <div id="toc" class="toc2">
            <div class="fallback-toc">
                <ul class="sectlevel1">
<li><a href="#_ugtst">1. Testing</a>
<ul class="sectlevel2">
<li><a href="#_other_guides">1.1. Other Guides</a></li>
</ul>
</li>
<li><a href="#_ugtst_aaa">2. Overview</a>
<ul class="sectlevel2">
<li><a href="#_unit_tests_vs_integ_tests">2.1. Unit tests vs Integ tests</a></li>
<li><a href="#_integ_tests_vs_bdd_specs">2.2. Integ tests vs BDD Specs</a></li>
<li><a href="#_simulated_ui_code_wrapperfactory_code">2.3. Simulated UI (<code>WrapperFactory</code>)</a></li>
<li><a href="#_dependency_injection">2.4. Dependency Injection</a></li>
<li><a href="#_given_when_then">2.5. Given/When/Then</a></li>
<li><a href="#_fixture_management">2.6. Fixture Management</a></li>
<li><a href="#_fake_data">2.7. Fake data</a></li>
<li><a href="#_feature_toggles">2.8. Feature Toggles</a></li>
</ul>
</li>
<li><a href="#_ugtst_unit-test-support">3. Unit Test Support</a>
<ul class="sectlevel2">
<li><a href="#_ugtst_unit-test-support_contract-tests">3.1. Contract Tests</a>
<ul class="sectlevel3">
<li><a href="#__code_sortedset_code_s">3.1.1. <code>SortedSet</code>s</a></li>
<li><a href="#_bidirectional">3.1.2. Bidirectional</a></li>
<li><a href="#_injected_services_method">3.1.3. Injected Services Method</a></li>
<li><a href="#_value_objects">3.1.4. Value Objects</a></li>
</ul>
</li>
<li><a href="#_ugtst_unit-test-support_jmock-extensions">3.2. JMock Extensions</a></li>
<li><a href="#_ugtst_unit-test-support_soap-fake-server-junit-rule">3.3. SOAP Fake Endpoints</a>
<ul class="sectlevel3">
<li><a href="#__code_soapendpointpublishingrule_code">3.3.1. <code>SoapEndpointPublishingRule</code></a></li>
<li><a href="#_xml_marshalling_support">3.3.2. XML Marshalling Support</a></li>
</ul>
</li>
<li><a href="#_ugtst_unit-test-support_maven-configuration">3.4. Maven Configuration</a></li>
</ul>
</li>
<li><a href="#_ugtst_integ-test-support">4. Integration Test Support</a>
<ul class="sectlevel2">
<li><a href="#_ugtst_integ-test-support_typical-usage">4.1. Typical Usage</a></li>
<li><a href="#_ugtst_integ-test-support_bootstrapping">4.2. Bootstrapping</a>
<ul class="sectlevel3">
<li><a href="#_system_initializer">4.2.1. System Initializer</a>
<ul class="sectlevel4">
<li><a href="#_1_9_0_code_appmanifest_code">1.9.0 (<code>AppManifest</code>)</a></li>
<li><a href="#_1_8_0_and_earlier">1.8.0 and earlier</a></li>
<li><a href="#_isisconfigurationforjdointegtests">IsisConfigurationForJdoIntegTests</a></li>
</ul>
</li>
<li><a href="#_abstract_class">4.2.2. Abstract Class</a>
<ul class="sectlevel4">
<li><a href="#_ugtst_integ-test-support_bootstrapping_IntegrationTestAbstract"><code>IntegrationTestAbstract</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_ugtst_integ-test-support_wrapper-factory">4.3. Wrapper Factory</a>
<ul class="sectlevel3">
<li><a href="#_wrapping_and_unwrapping">4.3.1. Wrapping and Unwrapping</a></li>
<li><a href="#_using_the_wrapper">4.3.2. Using the wrapper</a></li>
<li><a href="#_firing_domain_events">4.3.3. Firing Domain Events</a></li>
</ul>
</li>
<li><a href="#_ugtst_integ-test-support_maven-configuration">4.4. Maven Configuration</a></li>
</ul>
</li>
<li><a href="#_ugtst_bdd-spec-support">5. BDD Spec Support</a>
<ul class="sectlevel2">
<li><a href="#_ugtst_bdd-spec-support_how-it-works">5.1. How it works</a></li>
<li><a href="#_ugtst_bdd-spec-support_key-classes">5.2. Key classes</a>
<ul class="sectlevel3">
<li><a href="#__code_isissystemfortest_code">5.2.1. <code>IsisSystemForTest</code></a></li>
<li><a href="#__code_scenarioexecution_code">5.2.2. <code>ScenarioExecution</code></a></li>
<li><a href="#__code_wrapperfactory_code">5.2.3. <code>WrapperFactory</code></a></li>
<li><a href="#__code_cukeglueabstract_code">5.2.4. <code>CukeGlueAbstract</code></a></li>
</ul>
</li>
<li><a href="#_ugtst_bdd-spec-support_writing-a-bdd-spec">5.3. Writing a BDD spec</a></li>
<li><a href="#_ugtst_bdd-spec-support_bdd-tooling">5.4. BDD Tooling</a></li>
<li><a href="#_ugtst_bdd-spec-support_maven-configuration">5.5. Maven Configuration</a></li>
</ul>
</li>
<li><a href="#_ugtst_fixture-scripts">6. Fixture Scripts</a>
<ul class="sectlevel2">
<li><a href="#_ugtst_fixture-scripts_api-and-usage">6.1. API and Usage</a>
<ul class="sectlevel3">
<li><a href="#__code_fixturescripts_code">6.1.1. <code>FixtureScripts</code></a></li>
<li><a href="#__code_fixturescript_code">6.1.2. <code>FixtureScript</code></a></li>
<li><a href="#_using_within_tests">6.1.3. Using within Tests</a></li>
<li><a href="#_ugtst_fixture-scripts_api-and-usage_organizing">6.1.4. Organizing Fixture scripts</a>
<ul class="sectlevel4">
<li><a href="#_further_approaches">Further approaches</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_ugtst_fixture-scripts_sudo-service">6.2. <code>SudoService</code></a></li>
</ul>
</li>
</ul>
            </div>
        </div>
    </div>

</div>


<script src="../js/foundation/5.5.1/vendor/jquery.js"></script>
<script src="../js/foundation/5.5.1/foundation.min.js"></script>


<link href="../css/jquery.tocify/1.9.0/jquery.tocify.css" rel="stylesheet">
<script src="../js/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script src="../js/jquery.tocify/1.9.0/jquery.tocify.js"></script>



<script type="text/javascript">
    $(function () {
        $("#toc").tocify({
            scrollTo: 50,
            extendPage: true,
            context: "#doc-content",
            highlightOnScroll: true,
            hashGenerator: "pretty",
            hideEffect: "slideUp",
            selectors: "h2,h3,h4,h5"
        });
        $(".fallback-toc").hide();
    });
</script>

<script type="text/javascript">

  /****

      $(document).foundation();

      $(document).ready(function(){
        // Cache selectors
        var lastId,
            topMenu = $("div#toc ul"),
            topMenuHeight = 100,

            menuItems = topMenu.find("a"),
            menuItemsHrefs = menuItems.map(function(){
              var item = $($(this).attr("href"));
              if (item.length) { return item; }
            });

        // Bind click handler to menu items to scroll animation
        menuItems.click(function(e){
          var href = $(this).attr("href"),
              offsetTop = href === "#" ? 0 : $(href).offset().top-topMenuHeight+1;
          $('html, body').stop().animate({
              scrollTop: offsetTop
          }, 300);

          e.preventDefault();
        });

        // Bind to scroll of window
        $(  window ).scroll(function(){

           // Get container scroll position
           var fromTop = $(this).scrollTop()+topMenuHeight;

           var cur = menuItemsHrefs.map(function(){
             if ($(this).offset().top < fromTop)
               return this;
           });

           // Get the id of the current element
           cur = cur[cur.length-1];

           var id = cur && cur.length ? cur[0].id : "";

           if (lastId !== id && id) {
               scrollTo(id);
           }

           window.history.pushState({}, "", window.location.origin + window.location.pathname + "#" + id);
        });

        scrollTo = function(id) {
              lastId = id;

              menuItems
                .removeClass("active");

              menuItems
                .parents()
                .removeClass("active-region");

              menuItems
                .parents("ul").hide();

              menuItems
                .filter("[href=#"+id+"]")
                .addClass("active");

              menuItems
                .filter("[href=#"+id+"]")
                .parents("ul").show();

              menuItems
                .filter("[href=#"+id+"]")
                .parent().children("ul").show();

              menuItems
                .filter("[href=#"+id+"]")
                .parents("li").addClass("active-region");

        }
      menuItems
        .removeClass("active");

      menuItems
        .parents()
        .removeClass("active-region");

        var syncMenuItem;
        if(window.location.hash!=="") {
            var menuItemFor = $.grep(menuItems, function(e) {
                return e.hash === window.location.hash;
            });
            console.log(menuItemFor);
            if(menuItemFor.length === 1) {
                syncMenuItem = menuItemFor[0];
            }
        }

        if(!syncMenuItem){
            syncMenuItem = menuItems[0];
        }

        $(syncMenuItem).click();

      });

    ***/

</script>

<script type="text/javascript">

$(document).ready(function(){
    if("Documentation" === "Testing") {
        console.log( "processing 'Documentation'" );

        $("#doc-content-left").removeClass("large-9").removeClass("medium-9").addClass("large-12").addClass("medium-12");
        $("#doc-content-right").removeClass("large-3").removeClass("medium-3").hide();
    }

});

</script>


<script>

$( document ).ready(function() {

    (function() {
      $(function() {
        return $("#doc-content h2, #doc-content h3, #doc-content h4, #doc-content h5, #doc-content h6").each(function(i, el) {
          var $el, icon, id;
          $el = $(el);
          id = $el.attr('id');
          icon = '<i class="fa fa-link"></i>';
          if (id) {
            return $el.prepend($("<a />").addClass("header-link").attr("href", "#" + id).html(icon));
          }
        });
      });
    }).call(this);



	/*
        http://osvaldas.info/auto-hide-sticky-header
        MIT license
	*/
	;( function( $, window, document, undefined )
	{
		'use strict';

		var elSelector		= '.header',
			elClassHidden	= 'header--hidden',
			throttleTimeout	= 500,
			$element		= $( elSelector );

		if( !$element.length ) return true;

		var $window			= $( window ),
			wHeight			= 0,
			wScrollCurrent	= 0,
			wScrollBefore	= 0,
			wScrollDiff		= 0,
			$document		= $( document ),
			dHeight			= 0,

			throttle = function( delay, fn )
			{
				var last, deferTimer;
				return function()
				{
					var context = this, args = arguments, now = +new Date;
					if( last && now < last + delay )
					{
						clearTimeout( deferTimer );
						deferTimer = setTimeout( function(){ last = now; fn.apply( context, args ); }, delay );
					}
					else
					{
						last = now;
						fn.apply( context, args );
					}
				};
			};

		$window.on( 'scroll', throttle( throttleTimeout, function()
		{
			dHeight			= $document.height();
			wHeight			= $window.height();
			wScrollCurrent	= $window.scrollTop();
			wScrollDiff		= wScrollBefore - wScrollCurrent;

			if( wScrollCurrent <= 0 ) // scrolled to the very top; element sticks to the top
				$element.removeClass( elClassHidden );

			else if( wScrollDiff > 0 && $element.hasClass( elClassHidden ) ) // scrolled up; element slides in
				$element.removeClass( elClassHidden );

			else if( wScrollDiff < 0 ) // scrolled down
			{
				if( wScrollCurrent + wHeight >= dHeight && $element.hasClass( elClassHidden ) ) // scrolled to the very bottom; element slides in
					$element.removeClass( elClassHidden );

				else // scrolled down; element slides out
					$element.addClass( elClassHidden );
			}

			wScrollBefore = wScrollCurrent;
		}));

	})( jQuery, window, document );


});
</script>

</body>
</html>
